@use "../../utils/themes" as themes;
@use "../../utils/colors" as colors;
@use "../../utils/typography" as typography;
@use "../../utils/mixins" as mixins;
@use "../../utils/sheet-tokens" as tokens;
@use "sass:math";
@use "sass:list";

// ===================================
// ERPS DATA TABLES COMPONENT
// ===================================
// Modern, reusable data table component following BEM methodology
// Integrates with the Eventide RP System theme system
// Designed for use across character sheets, item sheets, and other components

// ===================================
// CONFIGURATION VARIABLES
// ===================================
// Using sheet-tokens where possible, only defining table-specific values

// Spacing and sizing (using sheet-tokens)
$erps-table-border-radius: tokens.$sheet-radius-lg;
$erps-table-header-height: tokens.$sheet-height-header;
$erps-table-header-height-compact: tokens.$sheet-height-header-compact;
$erps-table-cell-padding: tokens.$sheet-padding-cell;
$erps-table-cell-padding-compact: tokens.$sheet-padding-cell-compact;
$erps-table-cell-padding-name: tokens.$sheet-spacing-sm tokens.$sheet-spacing-base;
$erps-table-cell-padding-controls: tokens.$sheet-spacing-md;
$erps-table-control-gap: tokens.$sheet-spacing-xs;

// Control buttons
$erps-table-control-size: 2rem;
$erps-table-control-border-radius: tokens.$sheet-radius-md;

// Typography (using sheet-tokens)
$erps-table-header-font-size: tokens.$sheet-font-size-sm;
$erps-table-cell-font-size: tokens.$sheet-font-size-sm;
$erps-table-cell-font-size-compact: tokens.$sheet-font-size-xs;
$erps-table-control-font-size: tokens.$sheet-font-size-xs;
$erps-table-header-font-weight: tokens.$sheet-font-weight-semibold;
$erps-table-header-letter-spacing: tokens.$sheet-letter-spacing-base;

// Borders and effects (using sheet-tokens)
$erps-table-border-width: tokens.$sheet-border-thin;
$erps-table-border-width-thick: tokens.$sheet-border-base;
$erps-table-border-width-accent: tokens.$sheet-border-thick;
$erps-table-border-width-highlight: tokens.$sheet-border-accent;

// Transitions and animations (using sheet-tokens)
$erps-table-transition-duration: tokens.$sheet-transition-fast;
$erps-table-transition-duration-long: tokens.$sheet-transition-base;
$erps-table-animation-duration-glow: tokens.$sheet-animation-glow;
$erps-table-animation-duration-shift: tokens.$sheet-animation-shift;
$erps-table-animation-duration-pulse: tokens.$sheet-animation-pulse;

// Opacity values (using sheet-tokens)
$erps-table-opacity-disabled: tokens.$sheet-opacity-disabled;
$erps-table-opacity-unequipped: tokens.$sheet-opacity-unequipped;
$erps-table-opacity-unequipped-table: tokens.$sheet-opacity-default;

// Z-index values (using sheet-tokens)
$erps-table-z-index-base: tokens.$sheet-z-index-base;
$erps-table-z-index-overlay: tokens.$sheet-z-index-overlay;
$erps-table-z-index-header: tokens.$sheet-z-index-header;

// Transform values (using sheet-tokens)
$erps-table-transform-hover-y: tokens.$sheet-transform-hover-sm;
$erps-table-transform-hover-scale: tokens.$sheet-transform-scale-hover;
$erps-table-transform-active-scale: tokens.$sheet-transform-scale-active;
$erps-table-transform-glow-scale: 1.1;

// Image and icon sizes (using sheet-tokens)
$erps-table-image-size: tokens.$sheet-size-image;
$erps-table-image-border-radius: tokens.$sheet-radius-sm;
$erps-table-icon-size: 15pt;
$erps-table-icon-size-large: 14pt;

// Line height and spacing (using sheet-tokens)
$erps-table-line-height: tokens.$sheet-line-height-tight;
$erps-table-gap-small: tokens.$sheet-spacing-sm;
$erps-table-gap-medium: tokens.$sheet-spacing-xs;

// Create button specific (using sheet-tokens)
$erps-table-create-button-padding: tokens.$sheet-spacing-sm tokens.$sheet-spacing-base;
$erps-table-create-button-font-size: tokens.$sheet-font-size-xs;

// Layout percentages
$erps-table-width-half: tokens.$sheet-percent-half;
$erps-table-width-quarter: tokens.$sheet-percent-quarter;
$erps-table-width-third: tokens.$sheet-percent-third;
$erps-table-width-fifth: 22%;
$erps-table-width-two-fifths: 40%;
$erps-table-width-one-fifth: 20%;
$erps-table-width-quarter-plus: 26%;

// Responsive breakpoint (using sheet-tokens)
$erps-table-responsive-breakpoint: tokens.$sheet-table-responsive-breakpoint;
$erps-table-responsive-label-width: tokens.$sheet-table-responsive-label-width;
$erps-table-responsive-margin: tokens.$sheet-spacing-sm;
$erps-table-responsive-padding: tokens.$sheet-spacing-sm;

// Transformation specific
$erps-table-transformation-min-width: 200px;
$erps-table-transformation-border-width: tokens.$sheet-border-accent;

// ===================================
// UTILITY MIXINS
// ===================================
// Using the theme system and tokens for cleaner, more maintainable code

// Utility mixins for common patterns
@mixin button-glow($color, $opacity: 60) {
  box-shadow: 0 0 12px themes.color($color, $opacity);
}

@mixin element-glow($color, $opacity: 60, $size: 8px) {
  box-shadow: 0 0 $size themes.color($color, $opacity);
}

@mixin multi-shadow($shadows...) {
  box-shadow: $shadows;
}

// Gradient mixins for common patterns
@mixin button-gradient($color, $start-opacity: 20, $end-opacity: 30) {
  background: linear-gradient(135deg, themes.color($color, $start-opacity), themes.color($color, $end-opacity));
}

@mixin state-gradient($color, $start-opacity: 15, $end-var: var(--theme-accent)) {
  background: linear-gradient(135deg, themes.color($color, $start-opacity) 0%, $end-var 100%);
}

// Border radius utility mixins
@mixin table-border-radius-none {
  border-radius: 0;
  overflow: visible;
}

@mixin table-border-radius-top-only {
  border-radius: $erps-table-border-radius $erps-table-border-radius 0 0;
}

@mixin table-border-radius-bottom-only {
  border-radius: 0 0 $erps-table-border-radius $erps-table-border-radius;
}

@mixin table-border-radius-full {
  border-radius: $erps-table-border-radius;
  overflow: hidden;
}

// ===================================
// LAYOUT MIXINS
// ===================================

// Generic column distribution mixins for flexible layouts
@mixin table-columns-equal($count) {
  table-layout: fixed;

  @for $i from 1 through $count {
    .erps-data-table__header-cell:nth-child(#{$i}),
    .erps-data-table__cell:nth-child(#{$i}) {
      width: math.percentage(math.div(1, $count));
    }
  }
}

@mixin table-columns-custom($widths...) {
  table-layout: fixed;

  @for $i from 1 through list.length($widths) {
    .erps-data-table__header-cell:nth-child(#{$i}),
    .erps-data-table__cell:nth-child(#{$i}) {
      width: list.nth($widths, $i);
    }
  }
}

@mixin table-columns-auto-last($fixed-widths...) {
  table-layout: auto;

  @for $i from 1 through list.length($fixed-widths) {
    .erps-data-table__header-cell:nth-child(#{$i}),
    .erps-data-table__cell:nth-child(#{$i}) {
      width: list.nth($fixed-widths, $i);
    }
  }

  .erps-data-table__header-cell:last-child,
  .erps-data-table__cell:last-child {
    width: auto;
  }
}

@mixin table-columns-flex-last($fixed-widths...) {
  table-layout: auto;

  @for $i from 1 through list.length($fixed-widths) {
    .erps-data-table__header-cell:nth-child(#{$i}),
    .erps-data-table__cell:nth-child(#{$i}) {
      width: list.nth($fixed-widths, $i);
    }
  }

  .erps-data-table__header-cell:last-child,
  .erps-data-table__cell:last-child {
    width: 100%;
    justify-content: flex-end;
  }
}

// Responsive table mixins
@mixin table-responsive-stack {
  @media (width <= $erps-table-responsive-breakpoint) {
    .erps-data-table__header {
      display: none;
    }

    .erps-data-table__row {
      display: block;
      border: $erps-table-border-width solid themes.color(white, 10);
      border-radius: $erps-table-border-radius;
      margin-bottom: $erps-table-responsive-margin;
    }

    .erps-data-table__cell {
      display: block;
      text-align: left;
      padding: $erps-table-responsive-padding;
      border-bottom: none;

      &::before {
        content: attr(data-label) ": ";
        font-weight: bold;
        display: inline-block;
        width: $erps-table-responsive-label-width;
      }

      &--controls {
        text-align: right;
        justify-content: flex-end;
      }
    }
  }
}

@mixin table-responsive-scroll {
  .erps-data-table__container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
}

// ===================================
// CORE MIXINS FOR DATA TABLES
// ===================================

// Header styling mixins
@mixin table-header-gradient {
  background: linear-gradient(135deg,
    var(--theme-primary) 0%,
    var(--theme-secondary) 50%,
    var(--theme-primary) 100%);
}

@mixin animated-header-glow {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: tokens.$sheet-glow-width;
  height: 100%;
  background: linear-gradient(90deg,
    transparent,
    themes.color(white, 10),
    transparent);
  animation: erps-table-header-glow $erps-table-animation-duration-glow ease-in-out infinite;
  z-index: $erps-table-z-index-overlay;
}

@mixin header-cell-base {
  padding: $erps-table-cell-padding;
  font-family: var(--erps-ui-font);
  font-size: $erps-table-header-font-size;
  font-weight: $erps-table-header-font-weight;
  color: var(--theme-text);
  text-align: center;
  text-transform: uppercase;
  letter-spacing: $erps-table-header-letter-spacing;
  border-bottom: $erps-table-border-width-thick solid themes.color(white, 20);
  position: relative;
  z-index: $erps-table-z-index-header;
  text-shadow: 0 1px 2px themes.color(black, 80);
  vertical-align: middle;
  min-height: $erps-table-header-height;
  height: $erps-table-header-height;
}

// Row styling mixins
@mixin table-row-base {
  background: var(--theme-accent);
  transition: all $erps-table-transition-duration ease;
  border-bottom: $erps-table-border-width solid themes.color(white, 5);

  &:hover {
    background: var(--theme-pattern),
      linear-gradient(135deg,
        var(--theme-accent) 0%,
        var(--theme-primary) 100%);
    background-size: tokens.$sheet-table-pattern-size tokens.$sheet-table-pattern-size, 100% 100%;
    animation: erps-pattern-shift $erps-table-animation-duration-shift linear infinite;
    box-shadow: inset 0 0 tokens.$sheet-shadow-blur-xl themes.color(white, 10);
  }
}

@mixin selected-row {
  background: linear-gradient(135deg,
    themes.color(blue, 20) 0%,
    var(--theme-accent) 100%);
  border-left: $erps-table-border-width-highlight solid themes.color(blue, 80);
}

@mixin equipped-row {
  border-left: $erps-table-border-width-accent solid themes.color(green, 60);
  background: linear-gradient(135deg,
    themes.color(green, 8) 0%,
    var(--theme-accent) 100%);
}

@mixin unequipped-row {
  opacity: $erps-table-opacity-unequipped;
  border-left: $erps-table-border-width-accent solid themes.color(gray, 40);
  background: linear-gradient(135deg,
    themes.color(gray, 10) 0%,
    var(--theme-accent) 100%);
}

@mixin cursed-row {
  background: linear-gradient(135deg,
    themes.color(purple, 30) 0%,
    var(--theme-accent) 100%);
  border-left: $erps-table-border-width-highlight solid themes.color(purple, 80);
  animation: erps-cursed-pulse $erps-table-animation-duration-pulse ease-in-out infinite;
}

@mixin disabled-row {
  opacity: $erps-table-opacity-disabled;
  pointer-events: none;
}

// Cell styling mixins
@mixin table-cell-base {
  padding: $erps-table-cell-padding;
  font-family: var(--erps-info-font);
  font-size: $erps-table-cell-font-size;
  color: var(--theme-text);
  text-align: center;
  vertical-align: middle;
  border-bottom: $erps-table-border-width solid themes.color(white, 5);
}

@mixin name-cell {
  text-align: left;
  padding: $erps-table-cell-padding-name;
  vertical-align: middle;
}

@mixin numeric-cell {
  font-family: var(--erps-mono-font);
  font-weight: 500;
  text-align: right;
  vertical-align: middle;
}

@mixin controls-cell {
  text-align: right;
  white-space: nowrap;
  width: auto;
  min-width: min-content;
  padding: 0;
  vertical-align: middle;
  position: relative;
}

// Control button mixins
@mixin control-button-base {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: $erps-table-control-size;
  height: $erps-table-control-size;
  min-width: $erps-table-control-size;
  min-height: $erps-table-control-size;
  border-radius: $erps-table-control-border-radius;
  background: themes.color(white, 10);
  border: $erps-table-border-width solid themes.color(white, 20);
  color: var(--theme-text, #fff);
  cursor: pointer;
  transition: all $erps-table-transition-duration ease;
  font-size: $erps-table-control-font-size;
  text-decoration: none;
  position: relative;
  overflow: hidden;
  flex-shrink: 0;

  &::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: radial-gradient(circle, var(--theme-light, #{themes.color(blue, 70)}) 0%, transparent 70%);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: all $erps-table-transition-duration-long ease;
    z-index: $erps-table-z-index-base;
  }

  i {
    position: relative;
    z-index: $erps-table-z-index-overlay;
  }

  &:hover {
    background: var(--theme-primary, #{themes.color(blue, 90)});
    border-color: var(--theme-light, #{themes.color(blue, 70)});
    box-shadow: 0 0 tokens.$sheet-shadow-blur-lg var(--theme-glow, #{themes.color(blue, 60)});
    transform: translateY($erps-table-transform-hover-y) scale($erps-table-transform-hover-scale);

    &::before {
      width: 100%;
      height: 100%;
    }
  }

  &:active {
    transform: translateY(0) scale($erps-table-transform-active-scale);
  }
}

@mixin create-button {
  @include button-gradient(green);

  border-color: themes.color(green, 40);

  &:hover {
    background: themes.color(green, 80);
    border-color: themes.color(green, 80);

    @include button-glow(green);
  }
}

@mixin edit-button {
  @include button-gradient(blue);

  border-color: themes.color(blue, 40);

  &:hover {
    background: themes.color(blue, 90);
    border-color: themes.color(blue, 80);

    @include button-glow(blue);
  }
}

@mixin delete-button {
  background: linear-gradient(135deg, themes.color(red, 20), themes.color(red, 30));
  border-color: themes.color(red, 40);

  &:hover {
    background: themes.color(red, 80);
    border-color: themes.color(red, 80);

    @include button-glow(red);
  }
}

@mixin equip-button {
  background: linear-gradient(135deg, themes.color(orange, 20), themes.color(orange, 30));
  border-color: themes.color(orange, 40);

  &:hover {
    background: themes.color(orange, 80);
    border-color: themes.color(orange, 80);

    @include button-glow(orange);
  }
}

// Layout mixins
@mixin compact-table {
  .erps-data-table__header-cell,
  .erps-data-table__cell {
    padding: $erps-table-cell-padding-compact;
    font-size: $erps-table-cell-font-size-compact;
  }

  .erps-data-table__header-cell {
    height: $erps-table-header-height-compact;
    min-height: $erps-table-header-height-compact;
  }
}

@mixin bordered-table {
  border: $erps-table-border-width-thick solid var(--theme-light, #{themes.color(blue, 70)});
  box-shadow: 0 0 tokens.$sheet-shadow-blur-xl var(--theme-glow, #{themes.color(blue, 60)});
}

@mixin striped-table {
  .erps-data-table__row:nth-child(even) {
    background: linear-gradient(135deg,
      themes.color(white, 5) 0%,
      var(--theme-accent) 100%);
  }
}

// ===================================
// MAIN COMPONENT
// ===================================

.erps-data-table {
  // Base table styling
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  border-radius: $erps-table-border-radius;
  overflow: hidden;
  position: relative;

  // Theme-aware styling using CSS custom properties
  background: var(--erps-table-accent, var(--theme-accent, var(--erps-table-accent)));
  border: 2px solid var(--erps-table-primary, var(--theme-primary, var(--erps-table-primary)));
  box-shadow: 0 4px 16px rgb(0 0 0 / 25%), 0 0 20px var(--erps-table-glow, var(--theme-glow, var(--erps-table-glow)));

  // Container for responsive behavior
  &__container {
    width: 100%;
    overflow-x: auto;
    position: relative;
  }

  // Header styling
  &__header {
    @include table-header-gradient;

    position: relative;

    &::before {
      @include animated-header-glow;
    }
  }

  &__header-row {
    // Header row specific styling if needed
    width: 100%;
  }

  &__header-cell {
    @include header-cell-base;

    // Right align controls column headers
    &--controls {
      text-align: right;
      white-space: nowrap;
      vertical-align: middle;
      height: 100%;
    }

    // Left align name column headers
    &--name {
      text-align: left;
      vertical-align: middle;
    }

    // Center align by default (already in base)
    &--center {
      text-align: center;
      vertical-align: middle;
    }

    // Special styling for gear section titles
    &--section-title {
      text-align: left;
      display: flex;
      align-items: center;
      gap: $erps-table-gap-small;
      font-weight: 700;

      i {
        font-size: $erps-table-icon-size;
        opacity: 0.9;
        flex-shrink: 0;
      }
    }

    // Special styling for transformation header cell
    &--transformation {
      text-align: center;
      padding: $erps-table-cell-padding;
      background: linear-gradient(135deg, themes.color(purple, 30), themes.color(purple, 40));
      border-bottom: $erps-table-border-width-thick solid themes.color(purple, 60);
      vertical-align: middle;
    }
  }

  &__row {
    @include table-row-base;

    // State modifiers
    &--selected {
      @include selected-row;
    }

    &--disabled {
      @include disabled-row;
    }

    &--equipped {
      @include equipped-row;
    }

    &--unequipped {
      @include unequipped-row;
    }

    &--cursed {
      @include cursed-row;
    }
  }

  &__cell {
    @include table-cell-base;

    // Type modifiers
    &--name {
      @include name-cell;
    }

    &--numeric {
      @include numeric-cell;
    }

    &--controls {
      @include controls-cell;
    }

    &--center {
      text-align: center;
      vertical-align: middle;
    }

    &--left {
      text-align: left;
      vertical-align: middle;
    }

    &--right {
      text-align: right;
      vertical-align: middle;
    }
  }

  // Name cell content styling
  &__name-content {
    display: flex;
    align-items: center;
    gap: $erps-table-gap-small;
    width: 100%;
    height: 100%;

    img {
      width: $erps-table-image-size;
      height: $erps-table-image-size;
      border-radius: $erps-table-image-border-radius;
      border: $erps-table-border-width solid themes.color(white, 20);
      transition: all $erps-table-transition-duration ease;
      flex-shrink: 0;

      // Apply themed image backgrounds for all themes
      @include themes.apply-all-data-table-image-backgrounds('table-theme');

      &:hover {
        border-color: var(--erps-table-bright, var(--theme-bright, var(--erps-table-bright)));
        box-shadow: 0 0 8px var(--erps-table-glow, var(--theme-glow, var(--erps-table-glow)));
      }
    }

    span {
      line-height: $erps-table-line-height;
      flex: 1;
      min-width: 0;
    }

    a {
      flex-shrink: 0;
    }
  }

  // Controls system
  &__controls {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: $erps-table-gap-medium;
    flex-wrap: nowrap;
    height: 100%;
    min-height: 100%;
    width: 100%;
    position: absolute;
    top: 0;
    right: 0;
    padding: $erps-table-cell-padding-controls;
    box-sizing: border-box;
  }

  &__control-button {
    @include control-button-base;

    // Action modifiers
    &--create {
      @include create-button;
    }

    &--edit {
      @include edit-button;
    }

    &--delete {
      @include delete-button;
    }

    &--equip {
      @include equip-button;
    }

    // Special states
    &--disabled {
      opacity: $erps-table-opacity-disabled;
      cursor: not-allowed;
      pointer-events: none;
      background: themes.color(gray, 20);
      border-color: themes.color(gray, 30);
    }
  }

  // Create button with text (for headers)
  &__create-button {
    display: inline-flex;
    align-items: center;
    gap: $erps-table-gap-small;
    padding: $erps-table-create-button-padding;
    border-radius: $erps-table-control-border-radius;
    background: linear-gradient(135deg, themes.color(green, 20), themes.color(green, 30));
    border: $erps-table-border-width solid themes.color(green, 40);
    color: var(--theme-text, #fff);
    cursor: pointer;
    transition: all $erps-table-transition-duration ease;
    font-family: var(--erps-ui-font);
    font-size: $erps-table-create-button-font-size;
    font-weight: $erps-table-header-font-weight;
    text-decoration: none;
    text-transform: uppercase;
    letter-spacing: $erps-table-header-letter-spacing;

    &:hover {
      background: themes.color(green, 80);
      border-color: themes.color(green, 80);
      box-shadow: 0 0 tokens.$sheet-shadow-blur-lg themes.color(green, 60);
      transform: translateY($erps-table-transform-hover-y);
    }

    &:active {
      transform: translateY(0);
    }
  }

  // Table modifiers
  &--compact {
    @include compact-table;
  }

  &--bordered {
    @include bordered-table;
  }

  &--striped {
    @include striped-table;
  }

  // Border radius modifiers
  &--no-radius {
    @include table-border-radius-none;
  }

  &--radius-top-only {
    @include table-border-radius-top-only;
  }

  &--radius-bottom-only {
    @include table-border-radius-bottom-only;
  }

  &--radius-full {
    @include table-border-radius-full;
  }

  // Tab-specific styling for data tables (legacy - use --radius-bottom-only instead)
  &--flush-top {
    margin-top: 0;

    @include table-border-radius-bottom-only;
  }

  // Combination modifiers for common use cases
  &--flush-top-compact {
    @include compact-table;
    @include table-border-radius-bottom-only;

    margin-top: 0;
  }

  &--seamless {
    @include table-border-radius-none;

    margin: 0;
  }

  // Features layout
  &--features {
    @include table-columns-flex-last(100%);

    // Ensure consistent padding with other table types
    .erps-data-table__header-cell,
    .erps-data-table__cell {
      padding: $erps-table-cell-padding;
      font-size: $erps-table-cell-font-size;
    }

    .erps-data-table__header-cell {
      height: $erps-table-header-height;
      min-height: $erps-table-header-height;
    }
  }

  // Gear layout
  &--gear {
    @include table-columns-auto-last($erps-table-width-half, $erps-table-width-quarter, $erps-table-width-quarter);

    // Special styling for equipped gear tables
    &.erps-data-table--equipped {
      border-left: $erps-table-transformation-border-width solid themes.color(green, 60);
      box-shadow:
        0 2px tokens.$sheet-shadow-blur-md themes.color(black, 30),
        inset 0 1px 0 themes.color(white, 10),
        inset $erps-table-transformation-border-width 0 0 themes.color(green, 20);
    }

    // Special styling for unequipped gear tables
    &.erps-data-table--unequipped {
      border-left: $erps-table-transformation-border-width solid themes.color(gray, 40);
      opacity: $erps-table-opacity-unequipped-table;
      box-shadow:
        0 2px tokens.$sheet-shadow-blur-md themes.color(black, 30),
        inset 0 1px 0 themes.color(white, 10),
        inset $erps-table-transformation-border-width 0 0 themes.color(gray, 15);
    }
  }

  // Combat powers layout
  &--combat-powers {
    @include table-columns-auto-last($erps-table-width-two-fifths, $erps-table-width-one-fifth, $erps-table-width-two-fifths);
  }

  // Effects layout
  &--effects {
    @include table-columns-custom($erps-table-width-third, $erps-table-width-fifth, $erps-table-width-fifth, $erps-table-width-quarter-plus);

    // Ensure adequate space for 3rem ERPS inputs
    .erps-data-table__header-cell,
    .erps-data-table__cell {
      padding: 1rem; // Increased from 0.75rem 1rem to accommodate 3rem inputs
      vertical-align: middle;
      box-sizing: border-box;
    }

    .erps-data-table__header-cell {
      height: $erps-table-header-height;
      min-height: $erps-table-header-height;
    }

    // Ensure cells have adequate height for inputs without breaking layout
    .erps-data-table__cell {
      height: auto;
      min-height: 5rem; // Increased to 5rem for more breathing room
      position: relative;

      // Keep default table cell display, don't use flexbox
    }

    // Ensure ERPS inputs within effects table cells are properly sized
    .erps-input,
    .erps-select {
      width: 100%;
      max-width: 100%;
      min-width: 0;
      box-sizing: border-box;
    }

    .erps-number-input {
      width: 100%;
      max-width: 100%;
      display: flex;
      align-items: center;
      box-sizing: border-box;

      &__input {
        width: 100%;
        flex: 1;
        min-width: 0;
        box-sizing: border-box;
      }

      &__button {
        flex-shrink: 0;
        box-sizing: border-box;
      }
    }

    // Ensure control buttons are properly positioned without breaking cell layout
    .erps-data-table__cell--controls {
      text-align: center;
      vertical-align: middle;
      padding: 0.5rem;

      .erps-data-table__control-button {
        display: inline-flex;
      }
    }
  }

  // Statuses layout
  &--statuses {
    @include table-columns-auto-last(100%);

    // Ensure consistent padding with other table types
    .erps-data-table__header-cell,
    .erps-data-table__cell {
      padding: $erps-table-cell-padding;
      font-size: $erps-table-cell-font-size;
    }

    .erps-data-table__header-cell {
      height: $erps-table-header-height;
      min-height: $erps-table-header-height;
    }
  }
}

// ===================================
// ANIMATIONS
// ===================================

@keyframes erps-table-header-glow {
  0%, 100% {
    left: -100%;
  }

  50% {
    left: 100%;
  }
}

@keyframes erps-pattern-shift {
  0% {
    background-position: 0 0, 0 0;
  }

  100% {
    background-position: tokens.$sheet-table-pattern-size tokens.$sheet-table-pattern-size, 0 0;
  }
}

@keyframes erps-cursed-pulse {
  0%, 100% {
    box-shadow: 0 0 5px themes.color(purple, 40);
  }

  50% {
    box-shadow: 0 0 20px themes.color(purple, 80),
                inset 0 0 10px themes.color(purple, 30);
  }
}

@keyframes erps-transformation-glow {
  0%, 100% {
    opacity: 0.6;
    transform: scale(1);
  }

  50% {
    opacity: 1;
    transform: scale($erps-table-transform-glow-scale);
  }
}

// ===================================
// TRANSFORMATION SPECIFIC STYLING
// ===================================

// Transformation notice in header (replaces disabled create button)
.erps-data-table__transformation-notice {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: $erps-table-gap-small;
  padding: $erps-table-create-button-padding;
  border-radius: $erps-table-control-border-radius;
  background: linear-gradient(135deg, themes.color(purple, 20), themes.color(purple, 30));
  border: $erps-table-border-width solid themes.color(purple, 40);
  color: var(--theme-text, #fff);
  font-family: var(--erps-ui-font);
  font-size: $erps-table-create-button-font-size;
  font-weight: $erps-table-header-font-weight;
  text-transform: uppercase;
  letter-spacing: $erps-table-header-letter-spacing;
  animation: erps-transformation-glow $erps-table-animation-duration-pulse ease-in-out infinite;
  white-space: nowrap;
  width: 100%;
  min-width: $erps-table-transformation-min-width;
  box-sizing: border-box;

  i {
    font-size: $erps-table-icon-size-large;
    opacity: 0.9;
    flex-shrink: 0;

    &.fa-magic {
      color: themes.color(purple, 90);
      text-shadow: 0 0 6px themes.color(purple, 60);
    }

    &.fa-lock {
      color: themes.color(red, 90);
      text-shadow: 0 0 6px themes.color(red, 60);
    }
  }

  span {
    flex: 1;
    text-align: center;
    text-shadow: 0 1px 2px themes.color(black, 80);
    min-width: 0;
  }
}

// Transformation indicator in name cells
.erps-data-table__transformation-indicator {
  color: themes.color(purple, 90);
  text-shadow: 0 0 6px themes.color(purple, 60);
  font-size: $erps-table-icon-size-large;
  margin-left: $erps-table-gap-small;
  animation: erps-transformation-glow 2s ease-in-out infinite;
  flex-shrink: 0;
}

// Transformed row state
.erps-data-table__row--transformed {
  background: linear-gradient(135deg,
    themes.color(purple, 15) 0%,
    var(--theme-accent) 100%);
  border-left: $erps-table-transformation-border-width solid themes.color(purple, 60);
  position: relative;

  &::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: $erps-table-transformation-border-width;
    background: linear-gradient(180deg,
      themes.color(purple, 80) 0%,
      themes.color(purple, 60) 50%,
      themes.color(purple, 80) 100%);
    animation: erps-transformation-glow $erps-table-animation-duration-pulse ease-in-out infinite;
  }

  &:hover {
    background: linear-gradient(135deg,
      themes.color(purple, 25) 0%,
      var(--theme-primary) 100%);
    box-shadow: inset 0 0 tokens.$sheet-shadow-blur-xl themes.color(purple, 20);
  }

  // Ensure name cells in transformed rows are left-aligned
  .erps-data-table__cell--name {
    text-align: left;
  }
}

// Locked control buttons for transformation state
.erps-data-table__control-button--locked {
  background: linear-gradient(135deg, themes.color(purple, 30), themes.color(purple, 40));
  border-color: themes.color(purple, 60);
  animation: erps-cursed-pulse $erps-table-animation-duration-pulse ease-in-out infinite;

  i {
    color: themes.color(red, 90);
    text-shadow: 0 0 6px themes.color(red, 60);
  }

  &:hover {
    background: themes.color(purple, 60);
    border-color: themes.color(purple, 80);
    box-shadow: 0 0 15px themes.color(purple, 80);
  }
}

// ===================================
// LEGACY COMPATIBILITY SELECTORS
// ===================================
// Maintain compatibility with existing selectors from character sheet

.eventide-ability-row {
  border-radius: $erps-table-border-radius;
  padding: $erps-table-cell-padding-compact;
  color: themes.color(white);
  text-align: center;

  // Also target any children of ability-override (moved before main selector to fix specificity)
  .ability-override * {
    text-shadow: none;

    &:hover {
      text-shadow: none;
    }
  }

  // Apply hover effect only to direct children that are not inputs or ability-override
  > *:not(input, .ability-override):hover {
    text-shadow: 0 0 0.125rem themes.color(white), 0 0 0.25rem themes.color(white), 0 0 0.375rem themes.color(white);
    color: themes.color(white);
  }

  // Ensure ability-override never gets the hover effect
  .ability-override {
    color: themes.color(white);
    text-shadow: none;

    &:hover {
      text-shadow: none;
    }
  }
}

// ===================================
// THEME-AWARE SYSTEM
// ===================================
// Theme-aware system using CSS custom properties that inherit from the main theme
// This eliminates the need for JavaScript theme management

// Default theme variables that inherit from the main theme system
:root {
  --erps-table-primary: var(--theme-primary, #4a90e2);
  --erps-table-secondary: var(--theme-secondary, #357abd);
  --erps-table-bright: var(--theme-light, #6bb6ff);
  --erps-table-glow: var(--theme-glow, rgb(74 144 226 / 30%));
  --erps-table-text: var(--theme-text, #fff);
  --erps-table-accent: var(--theme-accent, #2c3e50);
}

// Theme-aware variants that inherit from the sheet's theme context
.eventide-sheet {
  // Inherit theme colors from the main theme system
  --erps-table-primary: var(--theme-primary);
  --erps-table-secondary: var(--theme-secondary);
  --erps-table-bright: var(--theme-light);
  --erps-table-glow: var(--theme-glow);
  --erps-table-text: var(--theme-text);
  --erps-table-accent: var(--theme-accent);
}

