@use "../../utils/themes" as themes;
@use "../../utils/sheet-tokens" as tokens;
@use "sass:map";

// ===================================
// ERPS FORMS COMPONENT
// ===================================
// Theme-aware form components for the Eventide RP System
// Includes form containers, content areas, field groups, labels, and headers

// ===================================
// CONFIGURATION VARIABLES
// ===================================

// Form sizing
$form-border-radius: tokens.$sheet-radius-xl;
$form-border-width: tokens.$sheet-border-base;
$form-padding: tokens.$sheet-spacing-lg;
$form-content-padding: tokens.$sheet-spacing-base;

// Group spacing
$group-spacing: tokens.$sheet-spacing-lg;
$group-padding: tokens.$sheet-spacing-md;

// Label styling
$label-font-size: tokens.$sheet-font-size-label-md;
$label-font-weight: tokens.$sheet-font-weight-semibold;
$label-margin-bottom: tokens.$sheet-spacing-xs;

// Header styling
$header-font-size: tokens.$sheet-font-size-lg;
$header-font-weight: tokens.$sheet-font-weight-bold;
$header-margin: tokens.$sheet-spacing-lg 0 tokens.$sheet-spacing-md 0;
$header-padding: tokens.$sheet-spacing-md 0;
$header-border-width: tokens.$sheet-border-thin;

// Transitions
$form-transition: all tokens.$sheet-transition-medium ease;

// ===================================
// MAIN FORM CONTAINER
// ===================================

.erps-form {
  position: relative;
  display: flex;
  flex-direction: column;
  width: 100%;
  height: 100%;
  background: var(--theme-accent, var(--erps-sheet-accent));
  border: $form-border-width solid var(--theme-secondary, var(--erps-sheet-secondary));
  border-radius: $form-border-radius;
  box-shadow:
    0 8px 32px rgb(0 0 0 / 40%),
    inset 0 1px 0 rgb(255 255 255 / 10%);
  overflow: hidden;
  font-family: var(--erps-ui-font, sans-serif);

  // Theme-aware background with pattern
  &::before {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--theme-pattern, none);
    background-size: 20px 20px;
    opacity: 0.1;
    pointer-events: none;
    z-index: 1;
  }

  // Ensure content is above pattern
  & > * {
    position: relative;
    z-index: 2;
  }

  // Form variants
  &--compact {
    padding: tokens.$sheet-spacing-md;
    border-radius: tokens.$sheet-radius-md;
  }

  &--large {
    padding: tokens.$sheet-spacing-xl;
    border-radius: tokens.$sheet-radius-xxl;
  }
}

// ===================================
// FORM CONTENT AREA
// ===================================

.erps-form__content {
  flex: 1;
  padding: $form-content-padding;
  overflow: hidden auto;

  // Custom scrollbar styling
  &::-webkit-scrollbar {
    width: 8px;
  }

  &::-webkit-scrollbar-track {
    background: var(--theme-accent, var(--erps-sheet-accent));
    border-radius: 4px;
  }

  &::-webkit-scrollbar-thumb {
    background: var(--theme-secondary, var(--erps-sheet-secondary));
    border-radius: 4px;
    border: 1px solid var(--theme-primary, var(--erps-sheet-primary));

    &:hover {
      background: var(--theme-light, var(--erps-sheet-light));
    }
  }

  // Ensure proper spacing for first and last elements
  & > *:first-child {
    margin-top: 0;
  }

  & > *:last-child {
    margin-bottom: 0;
  }
}

// ===================================
// FORM GROUPS
// ===================================

.erps-form__group {
  display: flex;
  flex-direction: column;
  gap: tokens.$sheet-spacing-xs;
  margin-bottom: $group-spacing;

  // Group variants
  &--horizontal {
    flex-direction: row;
    align-items: center;
    gap: tokens.$sheet-spacing-md;

    .erps-form__label {
      margin-bottom: 0;
      flex-shrink: 0;
      min-width: fit-content;
    }
  }

  &--compact {
    margin-bottom: tokens.$sheet-spacing-md;
    gap: tokens.$sheet-spacing-xxs;
  }

  &--spaced {
    margin-bottom: tokens.$sheet-spacing-xl;
  }

  // Grid layouts for complex forms
  &--grid {
    display: grid;
    gap: tokens.$sheet-spacing-md;

    &.erps-form__group--grid-2 {
      grid-template-columns: 1fr 1fr;
    }

    &.erps-form__group--grid-3 {
      grid-template-columns: 1fr 1fr 1fr;
    }

    &.erps-form__group--grid-auto {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
  }

  // Last group in content shouldn't have bottom margin
  &:last-child {
    margin-bottom: 0;
  }
}

// ===================================
// FORM LABELS
// ===================================

.erps-form__label {
  display: block;
  font-size: $label-font-size;
  font-weight: $label-font-weight;
  font-family: var(--erps-info-font, serif);
  color: var(--theme-text, var(--erps-sheet-text));
  margin-bottom: $label-margin-bottom;
  letter-spacing: tokens.$sheet-letter-spacing-tight;
  line-height: tokens.$sheet-line-height-tight;

  // Label variants
  &--required {
    &::after {
      content: ' *';
      color: themes.color(red, 80);
      font-weight: bold;
    }
  }

  &--optional {
    &::after {
      content: ' (optional)';
      font-weight: normal;
      opacity: 0.7;
      font-style: italic;
    }
  }

  &--large {
    font-size: tokens.$sheet-font-size-label-lg;
  }

  &--small {
    font-size: tokens.$sheet-font-size-label-sm;
  }

  // Interactive label states
  &:hover {
    color: var(--theme-light, var(--erps-sheet-light));
    transition: color tokens.$sheet-transition-fast ease;
  }
}

// ===================================
// FORM HEADERS
// ===================================

.erps-form__header {
  font-size: $header-font-size;
  font-weight: $header-font-weight;
  font-family: var(--erps-display-font, serif);
  color: var(--theme-text, var(--erps-sheet-text));
  margin: $header-margin;
  padding: $header-padding;
  border-bottom: $header-border-width solid var(--theme-secondary, var(--erps-sheet-secondary));
  letter-spacing: tokens.$sheet-letter-spacing-base;
  text-transform: uppercase;
  position: relative;

  // Decorative underline effect
  &::after {
    content: '';
    position: absolute;
    bottom: -$header-border-width;
    left: 0;
    width: 3rem;
    height: $header-border-width;
    background: var(--theme-glow, var(--erps-sheet-glow));
    transition: width tokens.$sheet-transition-medium ease;
  }

  &:hover::after {
    width: 6rem;
  }

  // Header variants
  &--large {
    font-size: tokens.$sheet-font-size-value-xl;
    margin: tokens.$sheet-spacing-xl 0 tokens.$sheet-spacing-lg 0;
  }

  &--small {
    font-size: tokens.$sheet-font-size-value-lg;
    margin: tokens.$sheet-spacing-md 0 tokens.$sheet-spacing-sm 0;
    text-transform: none;
  }

  &--centered {
    text-align: center;

    &::after {
      left: 50%;
      transform: translateX(-50%);
    }
  }

  &--no-border {
    border-bottom: none;
    padding-bottom: 0;

    &::after {
      display: none;
    }
  }

  // First header shouldn't have top margin
  &:first-child {
    margin-top: 0;
  }
}

// ===================================
// FORM DESCRIPTIONS
// ===================================

.erps-form__description {
  font-size: tokens.$sheet-font-size-value-md;
  font-family: var(--erps-ui-font, sans-serif);
  color: var(--theme-text, var(--erps-sheet-text));
  line-height: tokens.$sheet-line-height-loose;
  margin-bottom: tokens.$sheet-spacing-lg;
  padding: tokens.$sheet-spacing-md;
  background: rgb(0 0 0 / 10%);
  border-left: 3px solid var(--theme-secondary, var(--erps-sheet-secondary));
  border-radius: 0 tokens.$sheet-radius-sm tokens.$sheet-radius-sm 0;
  opacity: 0.9;

  // Description variants
  &--highlighted {
    background: var(--theme-primary, var(--erps-sheet-primary));
    border-left-color: var(--theme-glow, var(--erps-sheet-glow));
    box-shadow: 0 2px 8px rgb(0 0 0 / 20%);
  }

  &--compact {
    padding: tokens.$sheet-spacing-sm;
    margin-bottom: tokens.$sheet-spacing-md;
    font-size: tokens.$sheet-font-size-value-sm;
  }

  &--centered {
    text-align: center;
    border-left: none;
    border-top: 3px solid var(--theme-secondary, var(--erps-sheet-secondary));
    border-radius: tokens.$sheet-radius-sm tokens.$sheet-radius-sm 0 0;
  }

  // First description shouldn't have top margin
  &:first-child {
    margin-top: 0;
  }

  // Last description should have reduced bottom margin
  &:last-child {
    margin-bottom: tokens.$sheet-spacing-md;
  }
}

// ===================================
// FORM DIVIDERS
// ===================================

.erps-form__divider {
  border: none;
  height: 1px;
  background: linear-gradient(
    to right,
    transparent,
    var(--theme-secondary, var(--erps-sheet-secondary)) 20%,
    var(--theme-secondary, var(--erps-sheet-secondary)) 80%,
    transparent
  );
  margin: tokens.$sheet-spacing-lg 0;
  opacity: 0.6;

  // Divider variants
  &--thick {
    height: 2px;
    opacity: 0.8;
  }

  &--solid {
    background: var(--theme-secondary, var(--erps-sheet-secondary));
  }

  &--glow {
    background: var(--theme-glow, var(--erps-sheet-glow));
    box-shadow: 0 0 4px var(--theme-glow, var(--erps-sheet-glow));
    opacity: 0.8;
  }

  &--compact {
    margin: tokens.$sheet-spacing-md 0;
  }

  &--spaced {
    margin: tokens.$sheet-spacing-xl 0;
  }
}

// ===================================
// FORM SECTIONS
// ===================================

.erps-form__section {
  margin-bottom: tokens.$sheet-spacing-xl;
  padding: tokens.$sheet-spacing-md;
  background: rgb(0 0 0 / 10%);
  border: 1px solid var(--theme-secondary, var(--erps-sheet-secondary));
  border-radius: tokens.$sheet-radius-md;

  &--highlighted {
    background: var(--theme-primary, var(--erps-sheet-primary));
    border-color: var(--theme-light, var(--erps-sheet-light));
    box-shadow: 0 0 10px var(--theme-glow, var(--erps-sheet-glow));
  }

  &--compact {
    padding: tokens.$sheet-spacing-sm;
    margin-bottom: tokens.$sheet-spacing-md;
  }

  &:last-child {
    margin-bottom: 0;
  }
}

// ===================================
// RESPONSIVE DESIGN
// ===================================

@media (width <= 768px) {
  .erps-form {
    border-radius: tokens.$sheet-radius-md;
  }

  .erps-form__content {
    padding: tokens.$sheet-spacing-sm;
  }

  .erps-form__group {
    &--horizontal {
      flex-direction: column;
      align-items: stretch;

      .erps-form__label {
        margin-bottom: tokens.$sheet-spacing-xs;
      }
    }

    &--grid {
      &.erps-form__group--grid-2,
      &.erps-form__group--grid-3 {
        grid-template-columns: 1fr;
      }
    }
  }

  .erps-form__header {
    font-size: tokens.$sheet-font-size-value-lg;
    margin: tokens.$sheet-spacing-md 0 tokens.$sheet-spacing-sm 0;
  }
}

// ===================================
// GEAR CREATOR LAYOUT
// ===================================

// Gear creator specific layout components
.gear-creator {
  // Upper section with 3/5 + 2/5 layout
  &__upper-section {
    display: grid;
    grid-template-columns: 3fr 2fr;
    gap: tokens.$sheet-spacing-lg;
    margin-bottom: tokens.$sheet-spacing-lg;
    padding-bottom: tokens.$sheet-spacing-lg;
    border-bottom: 1px solid var(--erps-border-color, #444);

    @media (width <= 768px) {
      grid-template-columns: 1fr;
      gap: tokens.$sheet-spacing-md;
    }
  }

  // Main info section (3/5 width)
  &__main-info {
    display: flex;
    flex-direction: column;
    gap: tokens.$sheet-spacing-md;
  }

  // Visual info section (2/5 width)
  &__visual-info {
    display: flex;
    flex-direction: column;
    gap: tokens.$sheet-spacing-md;
    align-items: stretch;

    // Color picker grid layout
    .erps-color-picker-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: tokens.$sheet-spacing-sm;
    }
  }

  // Image group styling
  &__image-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  // Three-column layout for bottom section
  &__columns {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: tokens.$sheet-spacing-lg;

    @media (width <= 1024px) {
      grid-template-columns: 1fr 1fr;
      
      // Effects column spans full width on medium screens
      .gear-creator__column:nth-child(3) {
        grid-column: 1 / -1;
      }
    }

    @media (width <= 768px) {
      grid-template-columns: 1fr;
      gap: tokens.$sheet-spacing-md;
    }
  }

  // Individual column styling
  &__column {
    display: flex;
    flex-direction: column;
    gap: tokens.$sheet-spacing-md;

    // Effects column (third column) gets special narrow styling
    &:nth-child(3) {
      // Apply narrow styling directly to avoid @extend issues
      .erps-form__section {
        .erps-form__header {
          font-size: tokens.$sheet-font-size-value-sm;
          padding: tokens.$sheet-spacing-sm 0;
          margin-bottom: tokens.$sheet-spacing-sm;
        }

        .erps-form__group {
          margin-bottom: tokens.$sheet-spacing-sm;
        }

        .erps-form__label {
          font-size: tokens.$sheet-font-size-value-sm;
          margin-bottom: tokens.$sheet-spacing-xs;
        }
      }

      .erps-data-table {
        font-size: tokens.$sheet-font-size-value-sm;

        .erps-data-table__header-cell,
        .erps-data-table__cell {
          padding: tokens.$sheet-spacing-xs tokens.$sheet-spacing-sm;
        }

        .erps-data-table__header-cell {
          font-size: tokens.$sheet-font-size-value-sm;
          font-weight: tokens.$sheet-font-weight-semibold;
        }

        .erps-data-table__create-button {
          padding: tokens.$sheet-spacing-xs;
          font-size: tokens.$sheet-font-size-value-sm;
          
          i {
            margin-right: tokens.$sheet-spacing-xs;
          }
        }

        .erps-data-table__control-button {
          padding: tokens.$sheet-spacing-xs;
          min-width: auto;
          width: 24px;
          height: 24px;
          
          i {
            font-size: tokens.$sheet-font-size-value-sm;
          }
        }

        .erps-select {
          padding: tokens.$sheet-spacing-xs;
          font-size: tokens.$sheet-font-size-value-sm;
          min-height: 28px;
        }

        .erps-number-input {
          &__input {
            padding: tokens.$sheet-spacing-xs;
            font-size: tokens.$sheet-font-size-value-sm;
            min-height: 28px;
            width: 60px;
          }

          &__button {
            width: 24px;
            height: 28px;
            padding: 0;
            
            i {
              font-size: tokens.$sheet-font-size-value-sm;
            }
          }

          // Apply narrow styling directly in gear creator effects column
          &.erps-number-input--narrow {
            .erps-number-input__input {
              width: 50px;
              text-align: center;
            }

            .erps-number-input__button {
              display: none;
            }
          }
        }
      }
    }
  }
}

// ===================================
// FORM GRID SECTIONS
// ===================================

.erps-form__grid-section {
  margin-bottom: tokens.$sheet-spacing-lg;
  border: 1px solid var(--theme-secondary, var(--erps-sheet-secondary));
  border-radius: tokens.$sheet-radius-md;
  overflow: hidden;
  background: rgb(0 0 0 / 5%);
}

.erps-form__grid-header {
  display: grid;
  grid-template-columns: 2fr 1.5fr 1.5fr;
  gap: tokens.$sheet-spacing-sm;
  padding: tokens.$sheet-spacing-sm tokens.$sheet-spacing-md;
  background: var(--theme-primary, var(--erps-sheet-primary));
  border-bottom: 1px solid var(--theme-secondary, var(--erps-sheet-secondary));
  font-weight: tokens.$sheet-font-weight-semibold;
  font-size: tokens.$sheet-font-size-value-sm;
  text-transform: uppercase;
  letter-spacing: tokens.$sheet-letter-spacing-loose;
}

.erps-form__grid-header-cell {
  color: var(--theme-text, var(--erps-sheet-text));
  text-align: center;

  &:first-child {
    text-align: left;
  }
}

.erps-form__grid-row {
  display: grid;
  grid-template-columns: 2fr 1.5fr 1.5fr;
  gap: tokens.$sheet-spacing-sm;
  padding: tokens.$sheet-spacing-md;
  border-bottom: 1px solid var(--theme-secondary, var(--erps-sheet-secondary));
  align-items: center;

  &:last-child {
    border-bottom: none;
  }

  &:hover {
    background: rgb(255 255 255 / 3%);
  }
}

.erps-form__grid-cell {
  display: flex;
  align-items: center;
  min-height: 32px;
}

.erps-form__grid-label {
  font-size: tokens.$sheet-font-size-label-md;
  font-weight: tokens.$sheet-font-weight-semibold;
  font-family: var(--erps-info-font, serif);
  color: var(--theme-text, var(--erps-sheet-text));
  justify-content: flex-start;
}

// Responsive grid layout
@media (width <= 768px) {
  .erps-form__grid-header,
  .erps-form__grid-row {
    grid-template-columns: 1fr;
    gap: tokens.$sheet-spacing-xs;
  }

  .erps-form__grid-header-cell {
    text-align: left;
    
    &:not(:first-child) {
      display: none;
    }
  }

  .erps-form__grid-row {
    padding: tokens.$sheet-spacing-sm;
  }

  .erps-form__grid-cell {
    flex-direction: column;
    align-items: stretch;
    gap: tokens.$sheet-spacing-xs;
  }

  .erps-form__grid-label {
    font-size: tokens.$sheet-font-size-value-sm;
    margin-bottom: tokens.$sheet-spacing-xs;
  }
} 