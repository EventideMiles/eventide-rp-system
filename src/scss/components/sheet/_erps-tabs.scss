@use "../../utils/themes" as themes;
@use "../../utils/sheet-tokens" as tokens;
@use "sass:map";

// ===================================
// ERPS TABS COMPONENT
// ===================================
// Modern, reusable tab system component following BEM methodology
// Integrates with the Eventide RP System theme system
// Supports both standard Foundry tabs and custom gear tabs

// ===================================
// CONFIGURATION VARIABLES
// ===================================
// Using sheet-tokens for consistent design system integration

// Tab spacing and sizing
$tab-padding: tokens.$sheet-padding-tab;
$tab-padding-large: tokens.$sheet-padding-tab-large;
$tab-container-padding: tokens.$sheet-padding-tab-container;
$tab-gap: tokens.$sheet-spacing-sm;
$tab-margin-right: tokens.$sheet-margin-tab-right;
$tab-nav-margin-bottom: tokens.$sheet-margin-tab-nav-bottom;

// Tab dimensions
$tab-height-large: tokens.$sheet-height-tab-large;
$tab-count-size: tokens.$sheet-size-tab-count;
$tab-content-height-scrollable: tokens.$sheet-tab-content-height-scrollable;

// Typography
$tab-font-size: tokens.$sheet-font-size-xs;
$tab-font-size-sm: tokens.$sheet-font-size-sm;
$tab-font-size-md: tokens.$sheet-font-size-md;
$tab-font-weight: tokens.$sheet-font-weight-semibold;
$tab-font-weight-bold: tokens.$sheet-font-weight-bold;
$tab-letter-spacing: tokens.$sheet-letter-spacing-base;
$tab-line-height: tokens.$sheet-line-height-tight;

// Borders and radius
$tab-border-thin: tokens.$sheet-border-thin;
$tab-border-base: tokens.$sheet-border-base;
$tab-border-accent: tokens.$sheet-border-accent;
$tab-radius-sm: tokens.$sheet-radius-sm;
$tab-radius-md: tokens.$sheet-radius-md;
$tab-radius-lg: tokens.$sheet-radius-lg;
$tab-radius-xxl: tokens.$sheet-radius-xxl;

// Shadows and effects
$tab-shadow-blur-md: tokens.$sheet-shadow-blur-md;
$tab-shadow-blur-lg: tokens.$sheet-shadow-blur-lg;
$tab-shadow-blur-xxl: tokens.$sheet-shadow-blur-xxl;
$tab-glow-blur-sm: tokens.$sheet-glow-blur-sm;
$tab-glow-blur-md: tokens.$sheet-glow-blur-md;
$tab-glow-width: tokens.$sheet-glow-width;

// Transitions and animations
$tab-transition-base: tokens.$sheet-transition-base;
$tab-transition-medium: tokens.$sheet-transition-medium;
$tab-transition-slow: tokens.$sheet-transition-slow;
$tab-animation-glow: tokens.$sheet-animation-glow;

// Transforms and positioning
$tab-transform-hover-sm: tokens.$sheet-transform-hover-sm;
$tab-transform-hover-md: tokens.$sheet-transform-hover-md;
$tab-transform-fade: tokens.$sheet-transform-fade;
$tab-opacity-full: tokens.$sheet-opacity-full;
$tab-opacity-unequipped: tokens.$sheet-opacity-unequipped;

// Z-index values
$tab-z-index-base: tokens.$sheet-z-index-base;
$tab-z-index-overlay: tokens.$sheet-z-index-overlay;

// ===================================
// THEME SYSTEM
// ===================================
// Theme-aware system using CSS custom properties that inherit from the main theme

// Default theme variables that inherit from the main theme system
:root {
  --erps-tab-primary: var(--theme-primary, #4a90e2);
  --erps-tab-secondary: var(--theme-secondary, #357abd);
  --erps-tab-bright: var(--theme-light, #6bb6ff);
  --erps-tab-glow: var(--theme-glow, rgb(74 144 226 / 30%));
  --erps-tab-text: var(--theme-text, #fff);
}

// ===================================
// UTILITY MIXINS
// ===================================

// Tab glow effect
@mixin tab-glow($color, $opacity: 60) {
  box-shadow: 0 0 $tab-shadow-blur-xxl var(--theme-glow);
}

// Base shadow for tabs
@mixin tab-shadow-base {
  box-shadow: 0 4px $tab-shadow-blur-lg themes.color(black, 30);
}

// Active tab shadow with glow
@mixin tab-shadow-active($glow-color: var(--erps-tab-glow)) {
  box-shadow:
    0 4px $tab-shadow-blur-lg themes.color(black, 30),
    0 0 $tab-shadow-blur-xxl $glow-color;
}

// Tab gradient background
@mixin tab-gradient-background {
  background: linear-gradient(135deg,
    var(--erps-tab-primary) 0%,
    var(--erps-tab-secondary) 50%,
    var(--erps-tab-primary) 100%);
}

// Animated glow effect
@mixin tab-animated-glow {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: $tab-glow-width;
  height: 100%;
  background: linear-gradient(90deg,
    transparent,
    var(--erps-tab-bright),
    transparent);
  transition: left $tab-transition-slow ease;
  z-index: $tab-z-index-base;
}

// Border radius variants
@mixin tab-container-radius-top-only {
  border-radius: $tab-radius-md $tab-radius-md 0 0;
}

@mixin tab-container-radius-full {
  border-radius: $tab-radius-md;
}

@mixin tab-container-radius-none {
  border-radius: 0;
}

// Base tab container styling
@mixin tab-container-base {
  display: flex;
  flex-wrap: wrap;
  border-bottom: $tab-border-base solid var(--erps-tab-bright);

  @include tab-gradient-background;
  @include tab-container-radius-top-only;

  padding: $tab-container-padding;
  margin: 0;

  @include themes.themed-glow-shadow;
}

// Base tab item styling
@mixin tab-item-base {
  position: relative;
  padding: $tab-padding;
  border: $tab-border-thin solid var(--erps-tab-bright);
  border-bottom: none;
  border-radius: $tab-radius-md $tab-radius-md 0 0;
  font-family: var(--erps-ui-font) !important;
  font-size: $tab-font-size !important;
  font-weight: $tab-font-weight !important;
  text-transform: uppercase !important;
  letter-spacing: $tab-letter-spacing !important;
  color: var(--erps-tab-text) !important;
  background: var(--erps-tab-primary) !important;
  transition: all $tab-transition-medium ease;
  text-decoration: none !important;
  cursor: pointer;
  margin-right: $tab-margin-right;
  overflow: hidden;
  text-shadow: none !important;

  // Animated background effect
  &::before {
    @include tab-animated-glow;
  }

  // Text content above background effect
  & > * {
    position: relative;
    z-index: $tab-z-index-overlay;
  }
}

// Tab hover state
@mixin tab-hover-state {
  background: var(--erps-tab-primary) !important;
  border-color: var(--erps-tab-bright) !important;
  color: var(--erps-tab-text) !important;
  transform: translateY($tab-transform-hover-md);
  text-shadow: none !important;

  @include tab-shadow-base;

  &::before {
    left: 100%;
  }
}

// Tab active state
@mixin tab-active-state {
  background: var(--erps-tab-secondary) !important;
  border-color: var(--erps-tab-glow) !important;
  color: var(--erps-tab-text) !important;
  text-shadow: none !important;

  @include tab-shadow-active(var(--erps-tab-glow));

  transform: translateY($tab-transform-hover-sm);
  z-index: 10;

  &::before {
    left: 0;
    background: linear-gradient(90deg,
      var(--erps-tab-bright),
      transparent,
      var(--erps-tab-bright));
    opacity: 0.3;
    animation: erps-tab-glow $tab-animation-glow ease-in-out infinite;
  }

  &::after {
    display: none;
  }
}

// Custom tab button styling
@mixin custom-tab-button-base {
  display: flex;
  align-items: center;
  gap: $tab-gap;
  padding: $tab-padding-large;
  border: none;
  border-radius: $tab-radius-lg $tab-radius-lg 0 0;
  background: var(--erps-tab-primary);
  color: var(--erps-tab-text);
  cursor: pointer;
  transition: all $tab-transition-medium ease;
  font-family: var(--erps-ui-font);
  font-size: $tab-font-size-sm;
  font-weight: $tab-font-weight;
  text-transform: uppercase;
  letter-spacing: $tab-letter-spacing;
  position: relative;
  overflow: hidden;
  height: $tab-height-large;
  min-height: $tab-height-large;
  box-sizing: border-box;

  i {
    font-size: $tab-font-size-md;
    opacity: 0.8;
    transition: all $tab-transition-base ease;
  }

  &:hover i {
    opacity: $tab-opacity-full;
    transform: scale(1.1);
  }
}

// Tab content styling
@mixin tab-content-base {
  margin-top: 0;
  padding-top: 0;

  .eventide-sheet-data-section:first-child {
    margin-top: 0;
  }
}

@mixin tab-content-scrollable {
  height: $tab-content-height-scrollable;
  overflow-y: auto;

  section.main, aside.sidebar, .items-list {
    overflow: visible;
  }
}

@mixin tab-content-animated {
  display: none;
  width: 100%;
  animation: erps-tab-fade-in $tab-transition-medium ease-in-out;

  &.active {
    display: block;
  }
}

// Count/badge styling
@mixin tab-count-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: $tab-count-size;
  height: $tab-count-size;
  padding: 0 $tab-gap;
  border-radius: $tab-radius-xxl;
  background: var(--erps-tab-secondary);
  font-size: $tab-font-size;
  font-weight: $tab-font-weight-bold;
  line-height: $tab-line-height;
}

// Tab variant styling
@mixin tab-variant($color, $hover-theme: null) {
  @if $hover-theme {
    &.active, &:hover {
      --erps-tab-primary: var(--theme-primary);
      --erps-tab-secondary: var(--theme-secondary);
      --erps-tab-glow: var(--theme-glow);
    }
  }

  i {
    color: var(--theme-text);
  }
}

// Tab panel content styling
@mixin tab-panel-content($color, $opacity: null) {
  .eventide-actor-data-table, .erps-data-table {
    border-left: $tab-border-accent solid var(--theme-glow);

    @if $opacity {
      opacity: $opacity;
    }

    box-shadow:
      0 $tab-border-accent $tab-shadow-blur-lg themes.color(black, 30),
      inset 0 $tab-border-thin 0 var(--erps-tab-bright),
      inset $tab-border-accent 0 0 var(--theme-primary);
  }
}

// ===================================
// MAIN COMPONENT
// ===================================

.erps-tabs {
  // Standard Foundry tab container
  &__container {
    @include tab-container-base;

    &.sheet-tabs,
    .tabs {
      @include tab-container-base;
    }

    // Border radius variants
    &--radius-top-only {
      @include tab-container-radius-top-only;
    }

    &--radius-full {
      @include tab-container-radius-full;
    }

    &--radius-none {
      @include tab-container-radius-none;
    }
  }

  // Standard tab items
  &__item {
    @include tab-item-base;

    .item {
      font-family: var(--erps-ui-font);
      font-weight: $tab-font-weight;
      letter-spacing: $tab-letter-spacing;
    }

    &:hover:not(.active) {
      @include tab-hover-state;
    }

    &.active {
      @include tab-active-state;
    }
  }

  // Tab content areas
  &__content {
    @include tab-content-base;

    &--scrollable {
      @include tab-content-scrollable;
    }
  }

  // Custom tab navigation
  &__nav {
    display: flex;
    gap: $tab-gap;
    margin-bottom: $tab-nav-margin-bottom;
    border-bottom: $tab-border-base solid var(--erps-tab-bright);
    padding-bottom: $tab-gap;
  }

  // Custom tab buttons
  &__button {
    @include custom-tab-button-base;

    // Variant styling
    &--equipped {
      @include tab-variant(green, true);
    }

    &--unequipped {
      @include tab-variant(gray, true);
    }

    // Hover state
    &:hover {
      background: var(--erps-tab-primary);
      transform: translateY($tab-transform-hover-md);

      @include tab-shadow-base;

      .erps-tabs__count {
        background: var(--erps-tab-secondary);
      }
    }

    // Active state
    &.active {
      background: var(--erps-tab-secondary);

      @include tab-shadow-active(var(--erps-tab-glow));

      transform: translateY($tab-transform-hover-sm);

      i {
        opacity: $tab-opacity-full;
        text-shadow: 0 0 $tab-shadow-blur-md var(--erps-tab-glow);
      }

      .erps-tabs__count {
        background: var(--erps-tab-secondary);
        box-shadow: 0 0 $tab-shadow-blur-md var(--erps-tab-glow);
      }
    }
  }

  // Count/badge for custom tabs
  &__count {
    @include tab-count-badge;
  }

  // Custom tab content with animation
  &__panel {
    @include tab-content-animated;

    &--equipped {
      @include tab-panel-content(green);
    }

    &--unequipped {
      @include tab-panel-content(gray, $tab-opacity-unequipped);
    }
  }

  // Light theme overrides
  &--light {
    .erps-tabs__button {
      color: themes.color(black, 80);

      .erps-tabs__count {
        background: themes.color(black, 30);
        color: themes.color(black, 80);
      }

      &:hover .erps-tabs__count,
      &.active .erps-tabs__count {
        background: themes.color(black, 30);
        color: themes.color(black, 80);
      }
    }
  }
}

// ===================================
// LEGACY GEAR TAB SYSTEM
// ===================================

.gear-tab-nav {
  display: flex;
  gap: $tab-gap;
  margin-bottom: $tab-nav-margin-bottom;
  border-bottom: $tab-border-base solid var(--erps-tab-bright);
  padding-bottom: $tab-gap;
}

.gear-tab-button {
  @include custom-tab-button-base;

  // Variant styling
  &--equipped {
    @include tab-variant(green, true);
  }

  &--unequipped {
    @include tab-variant(gray, true);
  }

  &:hover {
    background: var(--erps-tab-primary);
    transform: translateY($tab-transform-hover-md);

    @include tab-shadow-base;

    .gear-count {
      background: var(--erps-tab-secondary);
    }
  }

  &.active {
    background: var(--erps-tab-secondary);
    transform: translateY($tab-transform-hover-sm);

    @include tab-shadow-active(var(--erps-tab-glow));

    i {
      opacity: $tab-opacity-full;
      text-shadow: 0 0 $tab-shadow-blur-md var(--erps-tab-glow);
    }

    .gear-count {
      background: var(--erps-tab-secondary);
      box-shadow: 0 0 $tab-shadow-blur-md var(--erps-tab-glow);
    }
  }

  .gear-count {
    @include tab-count-badge;
  }
}

.gear-tab-content {
  @include tab-content-animated;

  &--equipped {
    @include tab-panel-content(green);
  }

  &--unequipped {
    @include tab-panel-content(gray, $tab-opacity-unequipped);
  }
}

// ===================================
// ANIMATIONS
// ===================================

@keyframes erps-tab-glow {
  0%, 100% {
    opacity: 0.2;
  }

  50% {
    opacity: 0.4;
  }
}

@keyframes erps-tab-fade-in {
  from {
    opacity: 0;
    transform: translateY($tab-transform-fade);
  }

  to {
    opacity: 1;
    transform: translateY(0);
  }
}

// Theme-aware variants that inherit from the sheet's theme context
.eventide-sheet {
  // Inherit theme colors from the main theme system
  --erps-tab-primary: var(--theme-primary);
  --erps-tab-secondary: var(--theme-secondary);
  --erps-tab-bright: var(--theme-light);
  --erps-tab-glow: var(--theme-glow);
  --erps-tab-text: var(--theme-text);

  // ===================================
  // DYNAMIC TAB CONTAINER STYLING
  // ===================================

  // Rounded container for tabs with custom navigation
  .tabs.erps-tabs__container--rounded,
  .sheet-tabs.erps-tabs__container--rounded {
    @include tab-container-radius-full;

    margin-bottom: $tab-nav-margin-bottom;
  }

  // Flat container for tabs that connect to data tables
  .tabs.erps-tabs__container--flat,
  .sheet-tabs.erps-tabs__container--flat {
    @include tab-container-radius-top-only;

    margin-bottom: 0;
  }

  // Legacy static selectors for fallback compatibility
  .tab[data-tab="gear"] {
    .tabs,
    .sheet-tabs,
    .erps-tabs__container {
      border-radius: $tab-radius-md;
      margin-bottom: $tab-nav-margin-bottom;
    }
  }

  .tab--rounded-container,
  .tab--flat-container {
    .tabs,
    .sheet-tabs,
    .erps-tabs__container {
      border-radius: $tab-radius-md;
    }
  }

  // ===================================
  // LEGACY SELECTORS FOR COMPATIBILITY
  // ===================================

  // Tab navigation themed overrides
  .tabs .item {
    font-family: var(--erps-ui-font) !important;
    font-weight: $tab-font-weight !important;
    letter-spacing: $tab-letter-spacing !important;
    color: var(--erps-tab-text) !important;
    text-shadow: none !important;
  }

  // Themed tab system
  &.sheet-tabs,
  .tabs {
    @include tab-container-base;
  }

  // Themed tab items - these need !important to override Foundry defaults
  .tabs a[data-action="tab"] {
    @include tab-item-base;

    &:hover:not(.active) {
      @include tab-hover-state;
    }

    &.active {
      @include tab-active-state;
    }
  }

  // More specific selector for sheet tabs to ensure override
  .sheet-tabs.tabs a[data-action="tab"] {
    color: var(--erps-tab-text) !important;
    text-shadow: none !important;

    &:hover:not(.active) {
      color: var(--erps-tab-text) !important;
      text-shadow: none !important;
    }

    &.active {
      color: var(--erps-tab-text) !important;
      text-shadow: none !important;
    }
  }

  // Scrollable tabs modifier
  &--scrollbars {
    .tab {
      @include tab-content-scrollable;
    }
  }

  // Tab content styling
  .tab {
    @include tab-content-base;
  }

  // Light theme text color overrides
  &[data-bg-theme="light"] .gear-tab-button {
    color: themes.color(black, 80);

    .gear-count {
      background: themes.color(black, 30);
      color: themes.color(black, 80);
    }

    &:hover .gear-count,
    &.active .gear-count {
      background: themes.color(black, 30);
      color: themes.color(black, 80);
    }
  }
}
