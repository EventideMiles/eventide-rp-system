@use "../../utils/themes" as themes;
@use "../../utils/colors" as colors;
@use "../../utils/typography" as typography;
@use "../../utils/mixins" as mixins;
@use "../../utils/tokens" as tokens;
@use "../../utils/sheet-tokens" as sheet;
@use "sass:math";
@use "sass:list";

// ===================================
// ERPS TABS COMPONENT
// ===================================
// Modern, reusable tab system component following BEM methodology
// Integrates with the Eventide RP System theme system
// Supports both standard Foundry tabs and custom gear tabs

// ===================================
// MODERN COLOR FUNCTIONS & UTILITIES
// ===================================

// Utility mixins for tab-specific patterns
@mixin tab-glow($color, $opacity: 60) {
  box-shadow: 0 0 sheet.$sheet-shadow-blur-xxl themes.get-semantic-color($color, $opacity) !important;
}

@mixin tab-shadow-base {
  box-shadow: 0 4px sheet.$sheet-shadow-blur-lg themes.get-universal-color(black, 30) !important;
}

@mixin tab-shadow-active($glow-color: var(--theme-glow)) {
  box-shadow:
    0 4px sheet.$sheet-shadow-blur-lg themes.get-universal-color(black, 30),
    0 0 sheet.$sheet-shadow-blur-xxl $glow-color !important;
}

@mixin tab-gradient-background {
  background: linear-gradient(135deg,
    var(--theme-primary) sheet.$sheet-position-zero,
    var(--theme-secondary) sheet.$sheet-position-center,
    var(--theme-primary) sheet.$sheet-percent-full) !important;
}

@mixin tab-animated-glow {
  content: '' !important;
  position: absolute !important;
  top: sheet.$sheet-position-zero !important;
  left: (- sheet.$sheet-percent-full) !important;
  width: sheet.$sheet-glow-width !important;
  height: sheet.$sheet-percent-full !important;
  background: linear-gradient(90deg,
    transparent,
    themes.get-universal-color(white, 10),
    transparent) !important;
  transition: left sheet.$sheet-transition-slow ease !important;
  z-index: sheet.$sheet-z-index-base !important;
}

// ===================================
// TAB CONTAINER BORDER RADIUS UTILITIES
// ===================================

// Tab container border radius variants
@mixin tab-container-radius-top-only {
  border-radius: sheet.$sheet-radius-md sheet.$sheet-radius-md 0 0 !important;
}

@mixin tab-container-radius-full {
  border-radius: sheet.$sheet-radius-md !important;
}

@mixin tab-container-radius-none {
  border-radius: 0 !important;
}

// ===================================
// THEME-AWARE DEFAULTS FOR TABS
// ===================================

:root {
  // Default theme (blue)
  --erps-tab-primary: #4a90e2;
  --erps-tab-secondary: #357abd;
  --erps-tab-bright: #6bb6ff;
  --erps-tab-glow: rgb(74 144 226 / 30%);
  --erps-tab-text: #fff;
}

// Theme-specific defaults that activate based on sheet classes
.eventide-sheet[data-bg-theme="blue"] {
  --erps-tab-primary: #4a90e2;
  --erps-tab-secondary: #357abd;
  --erps-tab-bright: #6bb6ff;
  --erps-tab-glow: rgb(74 144 226 / 30%);
  --erps-tab-text: #fff;
}

.eventide-sheet[data-bg-theme="black"] {
  --erps-tab-primary: #2c2c2c;
  --erps-tab-secondary: #1a1a1a;
  --erps-tab-bright: #4a4a4a;
  --erps-tab-glow: rgb(44 44 44 / 30%);
  --erps-tab-text: #fff;
}

.eventide-sheet[data-bg-theme="green"] {
  --erps-tab-primary: #4a9e4a;
  --erps-tab-secondary: #357a35;
  --erps-tab-bright: #6bb66b;
  --erps-tab-glow: rgb(74 158 74 / 30%);
  --erps-tab-text: #fff;
}

.eventide-sheet[data-bg-theme="light"] {
  --erps-tab-primary: #e2e2e2;
  --erps-tab-secondary: #c0c0c0;
  --erps-tab-bright: #fff;
  --erps-tab-glow: rgb(226 226 226 / 30%);
  --erps-tab-text: #1a1a1a;
}

.eventide-sheet[data-bg-theme="gold"] {
  --erps-tab-primary: #d4af37;
  --erps-tab-secondary: #b8941f;
  --erps-tab-bright: #f4d03f;
  --erps-tab-glow: rgb(212 175 55 / 30%);
  --erps-tab-text: #fff;
}

.eventide-sheet[data-bg-theme="purple"] {
  --erps-tab-primary: #8e44ad;
  --erps-tab-secondary: #7d3c98;
  --erps-tab-bright: #a569bd;
  --erps-tab-glow: rgb(142 68 173 / 30%);
  --erps-tab-text: #fff;
}

// ===================================
// CORE MIXINS FOR TABS
// ===================================

// Base tab container styling
@mixin tab-container-base {
  display: flex !important;
  flex-wrap: wrap !important;
  border-bottom: sheet.$sheet-border-base solid themes.get-universal-color(white, 10) !important;

  @include tab-gradient-background;
  @include tab-container-radius-top-only; // Default: rounded top, flat bottom

  padding: sheet.$sheet-padding-tab-container !important;
  margin: sheet.$sheet-position-zero !important;

  @include themes.themed-glow-shadow;
}

// Base tab item styling
@mixin tab-item-base {
  position: relative !important;
  padding: sheet.$sheet-padding-tab !important;
  border: sheet.$sheet-border-thin solid themes.get-universal-color(white, 20) !important;
  border-bottom: none !important;
  border-radius: sheet.$sheet-radius-md sheet.$sheet-radius-md 0 0 !important;
  font-family: var(--erps-ui-font) !important;
  font-size: sheet.$sheet-font-size-xs !important;
  font-weight: sheet.$sheet-font-weight-semibold !important;
  text-transform: uppercase !important;
  letter-spacing: sheet.$sheet-letter-spacing-base !important;
  color: var(--erps-tab-text, var(--theme-text, var(--erps-tab-text))) !important;
  background: themes.get-universal-color(white, 10) !important;
  transition: all sheet.$sheet-transition-medium ease !important;
  text-decoration: none !important;
  cursor: pointer !important;
  margin-right: sheet.$sheet-margin-tab-right !important;
  overflow: hidden !important;

  // Animated background effect
  &::before {
    @include tab-animated-glow;
  }

  // Text content above background effect
  & > * {
    position: relative !important;
    z-index: sheet.$sheet-z-index-overlay !important;
  }
}

// Tab hover state
@mixin tab-hover-state {
  background: var(--erps-tab-primary, var(--theme-primary, var(--erps-tab-primary))) !important;
  border-color: var(--erps-tab-bright, var(--theme-bright, var(--erps-tab-bright))) !important;
  color: var(--erps-tab-text, var(--theme-text, var(--erps-tab-text))) !important;
  transform: translateY(sheet.$sheet-transform-hover-md) !important;

  @include tab-shadow-base;

  &::before {
    left: sheet.$sheet-percent-full !important;
  }
}

// Tab active state
@mixin tab-active-state {
  background: var(--erps-tab-secondary, var(--theme-secondary, var(--erps-tab-secondary))) !important;
  border-color: var(--erps-tab-glow, var(--theme-glow, var(--erps-tab-glow))) !important;
  color: var(--erps-tab-text, var(--theme-text, var(--erps-tab-text))) !important;

  @include tab-shadow-active(var(--erps-tab-glow, var(--theme-glow, var(--erps-tab-glow))));

  transform: translateY(sheet.$sheet-transform-hover-sm) !important;
  z-index: 10 !important;

  &::before {
    left: sheet.$sheet-position-zero !important;
    background: linear-gradient(90deg,
      var(--erps-tab-bright, var(--theme-bright, var(--erps-tab-bright))),
      transparent,
      var(--erps-tab-bright, var(--theme-bright, var(--erps-tab-bright)))) !important;
    opacity: 0.3 !important;
    animation: erps-tab-glow sheet.$sheet-animation-glow ease-in-out infinite !important;
  }

  // Remove the skewed background from global override
  &::after {
    display: none !important;
  }
}

// Custom tab button styling (for gear tabs)
@mixin custom-tab-button-base {
  display: flex !important;
  align-items: center !important;
  gap: sheet.$sheet-spacing-sm !important;
  padding: sheet.$sheet-padding-tab-large !important;
  border: none !important;
  border-radius: sheet.$sheet-radius-lg sheet.$sheet-radius-lg 0 0 !important;
  background: themes.get-universal-color(white, 10) !important;
  color: var(--erps-tab-text, var(--theme-text, var(--erps-tab-text))) !important;
  cursor: pointer !important;
  transition: all sheet.$sheet-transition-medium ease !important;
  font-family: var(--erps-ui-font) !important;
  font-size: sheet.$sheet-font-size-sm !important;
  font-weight: sheet.$sheet-font-weight-semibold !important;
  text-transform: uppercase !important;
  letter-spacing: sheet.$sheet-letter-spacing-base !important;
  position: relative !important;
  overflow: hidden !important;
  height: sheet.$sheet-height-tab-large !important;
  min-height: sheet.$sheet-height-tab-large !important;
  box-sizing: border-box !important;

  i {
    font-size: sheet.$sheet-font-size-md !important;
    opacity: 0.8 !important;
    transition: all sheet.$sheet-transition-base ease !important;
  }

  &:hover i {
    opacity: sheet.$sheet-opacity-full !important;
    transform: scale(1.1) !important;
  }
}

// Tab content styling
@mixin tab-content-base {
  margin-top: sheet.$sheet-position-zero !important;
  padding-top: sheet.$sheet-position-zero !important;

  // Remove top margin from first data section in each tab
  .eventide-sheet-data-section:first-child {
    margin-top: sheet.$sheet-position-zero !important;
  }
}

@mixin tab-content-scrollable {
  height: sheet.$sheet-tab-content-height-scrollable !important;
  overflow-y: auto !important;

  // Ensure all sections don't scroll individually
  section.main, aside.sidebar, .items-list {
    overflow: visible !important;
  }
}

@mixin tab-content-animated {
  display: none !important;
  width: sheet.$sheet-percent-full !important;
  animation: erps-tab-fade-in sheet.$sheet-transition-medium ease-in-out !important;

  &.active {
    display: block !important;
  }
}

// Count/badge styling for custom tabs
@mixin tab-count-badge {
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  min-width: sheet.$sheet-size-tab-count !important;
  height: sheet.$sheet-size-tab-count !important;
  padding: 0 sheet.$sheet-spacing-sm !important;
  border-radius: sheet.$sheet-radius-xxl !important;
  background: themes.get-universal-color(white, 10) !important;
  font-size: sheet.$sheet-font-size-xs !important;
  font-weight: sheet.$sheet-font-weight-bold !important;
  line-height: sheet.$sheet-line-height-tight !important;
}

// ===================================
// MAIN COMPONENT
// ===================================

.erps-tabs {
  // Standard Foundry tab container
  &__container {
    @include tab-container-base;

    // Override global tab styling with higher specificity
    &.sheet-tabs,
    .tabs {
      @include tab-container-base;
    }

    // Manual border radius overrides
    &--radius-top-only {
      @include tab-container-radius-top-only;
    }

    &--radius-full {
      @include tab-container-radius-full;
    }

    &--radius-none {
      @include tab-container-radius-none;
    }
  }

  // Standard tab items
  &__item {
    @include tab-item-base;

    // Font styling for tab text
    .item {
      font-family: var(--erps-ui-font) !important;
      font-weight: sheet.$sheet-font-weight-semibold !important;
      letter-spacing: sheet.$sheet-letter-spacing-base !important;
    }

    // Hover state
    &:hover:not(.active) {
      @include tab-hover-state;
    }

    // Active state
    &.active {
      @include tab-active-state;
    }
  }

  // Tab content areas
  &__content {
    @include tab-content-base;

    // Scrollable variant
    &--scrollable {
      @include tab-content-scrollable;
    }
  }

  // Custom tab navigation (for gear tabs, etc.)
  &__nav {
    display: flex !important;
    gap: sheet.$sheet-spacing-sm !important;
    margin-bottom: sheet.$sheet-margin-tab-nav-bottom !important;
    border-bottom: sheet.$sheet-border-base solid themes.get-universal-color(white, 10) !important;
    padding-bottom: sheet.$sheet-spacing-sm !important;
  }

  // Custom tab buttons
  &__button {
    @include custom-tab-button-base;

    // Equipped variant icon styling (must come before active state)
    &--equipped i {
      color: themes.get-semantic-color(green, 90) !important;
    }

    // Unequipped variant icon styling (must come before active state)
    &--unequipped i {
      color: themes.get-semantic-color(gray, 90) !important;
    }

    // Hover state
    &:hover {
      background: var(--theme-primary) !important;
      transform: translateY(sheet.$sheet-transform-hover-md) !important;

      @include tab-shadow-base;

      .erps-tabs__count {
        background: themes.get-universal-color(white, 20) !important;
      }
    }

    // Active state
    &.active {
      background: var(--theme-secondary) !important;

      @include tab-shadow-active(var(--theme-glow));

      transform: translateY(sheet.$sheet-transform-hover-sm) !important;

      .erps-tabs__count {
        background: themes.get-universal-color(white, 20) !important;
        box-shadow: 0 0 sheet.$sheet-shadow-blur-md themes.get-universal-color(white, 20) !important;
      }
    }

    // Active state icon styling (must come after variant icon styling)
    &.active i {
      opacity: sheet.$sheet-opacity-full !important;
      text-shadow: 0 0 sheet.$sheet-shadow-blur-md var(--theme-glow) !important;
    }

    // Equipped variant theme overrides
    &--equipped {
      &.active, &:hover {
        --theme-primary: #{themes.get-semantic-color(green, dark-90)};
        --theme-secondary: #{themes.get-semantic-color(green, 80)};
        --theme-glow: #{themes.get-semantic-color(green, 60)};
      }
    }

    // Unequipped variant theme overrides
    &--unequipped {
      &.active, &:hover {
        --theme-primary: #{themes.get-semantic-color(gray, 90)};
        --theme-secondary: #{themes.get-semantic-color(gray, 80)};
        --theme-glow: #{themes.get-semantic-color(gray, 60)};
      }
    }
  }

  // Count/badge for custom tabs
  &__count {
    @include tab-count-badge;
  }

  // Custom tab content with animation
  &__panel {
    @include tab-content-animated;

    // Equipped content styling
    &--equipped {
      .eventide-actor-data-table, .erps-data-table {
        border-left: sheet.$sheet-border-accent solid themes.get-semantic-color(green, 60) !important;
        box-shadow:
          0 sheet.$sheet-border-accent sheet.$sheet-shadow-blur-lg themes.get-universal-color(black, 30),
          inset 0 sheet.$sheet-border-thin 0 themes.get-universal-color(white, 10),
          inset sheet.$sheet-border-accent 0 0 themes.get-semantic-color(green, 20) !important;
      }
    }

    // Unequipped content styling
    &--unequipped {
      .eventide-actor-data-table, .erps-data-table {
        border-left: sheet.$sheet-border-accent solid themes.get-semantic-color(gray, 40) !important;
        opacity: sheet.$sheet-opacity-unequipped !important;
        box-shadow:
          0 sheet.$sheet-border-accent sheet.$sheet-shadow-blur-lg themes.get-universal-color(black, 30),
          inset 0 sheet.$sheet-border-thin 0 themes.get-universal-color(white, 10),
          inset sheet.$sheet-border-accent 0 0 themes.get-semantic-color(gray, 15) !important;
      }
    }
  }

  // Light theme overrides
  &--light {
    .erps-tabs__button {
      color: themes.get-universal-color(black, 80) !important;

      .erps-tabs__count {
        background: themes.get-universal-color(black, 30) !important;
        color: themes.get-universal-color(black, 80) !important;
      }

      &:hover .erps-tabs__count {
        background: themes.get-universal-color(black, 30) !important;
      }

      &.active .erps-tabs__count {
        background: themes.get-universal-color(black, 30) !important;
        color: themes.get-universal-color(black, 80) !important;
      }
    }
  }
}

// ===================================
// DYNAMIC TAB CONTAINER STYLING
// ===================================

// JavaScript-driven tab container styling based on active tab
// These classes are applied dynamically by the tab-container-styling.mjs module

.eventide-sheet {
  // Rounded container for tabs with custom navigation or standalone content
  .tabs.erps-tabs__container--rounded,
  .sheet-tabs.erps-tabs__container--rounded {
    @include tab-container-radius-full;

    margin-bottom: sheet.$sheet-margin-tab-nav-bottom !important;
  }

  // Flat container for tabs that connect directly to data tables
  .tabs.erps-tabs__container--flat,
  .sheet-tabs.erps-tabs__container--flat {
    @include tab-container-radius-top-only;

    margin-bottom: sheet.$sheet-position-zero !important;
  }

  // Legacy static selectors (kept for fallback compatibility)
  // These will be overridden by the JavaScript-driven classes above

  // Gear tab gets full rounding since it has its own navigation
  .tab[data-tab="gear"] {
    .tabs,
    .sheet-tabs,
    .erps-tabs__container {
      border-radius: sheet.$sheet-radius-md !important;
      margin-bottom: sheet.$sheet-margin-tab-nav-bottom !important;
    }
  }

  // Manual override classes for specific use cases
  .tab--rounded-container {
    .tabs,
    .sheet-tabs,
    .erps-tabs__container {
      border-radius: sheet.$sheet-radius-md !important;
    }
  }

  .tab--flat-container {
    .tabs,
    .sheet-tabs,
    .erps-tabs__container {
      border-radius: sheet.$sheet-radius-md !important;
    }
  }
}

// ===================================
// LEGACY SELECTORS FOR COMPATIBILITY
// ===================================
// These maintain compatibility with existing character sheet markup
// stylelint-disable-next-line
.eventide-sheet {
  // Tab navigation - themed overrides with high specificity
  .tabs .item {
    font-family: var(--erps-ui-font) !important;
    font-weight: sheet.$sheet-font-weight-semibold !important;
    letter-spacing: sheet.$sheet-letter-spacing-base !important;
  }

  // Themed tab system - override global tab styling with important declarations
  &.sheet-tabs,
  .tabs {
    @include tab-container-base;
  }

  // Themed tab items - base selector first, then more specific ones
  .tabs a[data-action="tab"] {
    @include tab-item-base;

    &:hover:not(.active) {
      @include tab-hover-state;
    }

    &.active {
      @include tab-active-state;
    }
  }

  // More specific selector for sheet tabs: uncomment if required
  // .sheet-tabs.tabs a[data-action="tab"] {
  //   // Inherits all styles from above, can add specific overrides here if needed
  // }

  // Scrollable tabs modifier
  &--scrollbars {
    .tab {
      @include tab-content-scrollable;
    }
  }

  // Tab content styling
  .tab {
    @include tab-content-base;
  }

  // Theme-specific text color overrides for gear tab buttons
  &[data-bg-theme="light"] .gear-tab-button {
    color: themes.get-universal-color(black, 80) !important;

    .gear-count {
      background: themes.get-universal-color(black, 30) !important;
      color: themes.get-universal-color(black, 80) !important;
    }

    &:hover .gear-count {
      background: themes.get-universal-color(black, 30) !important;
    }

    &.active .gear-count {
      background: themes.get-universal-color(black, 30) !important;
      color: themes.get-universal-color(black, 80) !important;
    }
  }
}

// Gear tab system (legacy selectors)
.gear-tab-nav {
  display: flex !important;
  gap: sheet.$sheet-spacing-sm !important;
  margin-bottom: sheet.$sheet-margin-tab-nav-bottom !important;
  border-bottom: sheet.$sheet-border-base solid themes.get-universal-color(white, 10) !important;
  padding-bottom: sheet.$sheet-spacing-sm !important;
}

.gear-tab-button {
  @include custom-tab-button-base;

  // Equipped gear button icon styling (must come before active state)
  &--equipped i {
    color: themes.get-semantic-color(green, 90) !important;
  }

  // Unequipped gear button icon styling (must come before active state)
  &--unequipped i {
    color: themes.get-semantic-color(gray, 90) !important;
  }

  &:hover {
    background: var(--theme-primary) !important;
    transform: translateY(sheet.$sheet-transform-hover-md) !important;

    @include tab-shadow-base;

    .gear-count {
      background: themes.get-universal-color(white, 20) !important;
    }
  }

  &.active {
    background: var(--theme-secondary) !important;

    @include tab-shadow-active(var(--theme-glow));

    transform: translateY(sheet.$sheet-transform-hover-sm) !important;

    .gear-count {
      background: themes.get-universal-color(white, 20) !important;
      box-shadow: 0 0 sheet.$sheet-shadow-blur-md themes.get-universal-color(white, 20) !important;
    }
  }

  // Active state icon styling (inherits from custom-tab-button-base mixin)
  &.active i {
    opacity: sheet.$sheet-opacity-full !important;
    text-shadow: 0 0 sheet.$sheet-shadow-blur-md var(--theme-glow) !important;
  }

  // Equipped gear button theme overrides
  &--equipped {
    &.active, &:hover {
      --theme-primary: #{themes.get-semantic-color(green, dark-90)};
      --theme-secondary: #{themes.get-semantic-color(green, 80)};
      --theme-glow: #{themes.get-semantic-color(green, 60)};
    }
  }

  // Unequipped gear button theme overrides
  &--unequipped {
    &.active, &:hover {
      --theme-primary: #{themes.get-semantic-color(gray, 90)};
      --theme-secondary: #{themes.get-semantic-color(gray, 80)};
      --theme-glow: #{themes.get-semantic-color(gray, 60)};
    }
  }

  .gear-count {
    @include tab-count-badge;
  }
}

// Gear tab content
.gear-tab-content {
  @include tab-content-animated;

  // Equipped gear content styling
  &--equipped {
    .eventide-actor-data-table {
      border-left: sheet.$sheet-border-accent solid themes.get-semantic-color(green, 60) !important;
      box-shadow:
        0 sheet.$sheet-border-accent sheet.$sheet-shadow-blur-lg themes.get-universal-color(black, 30),
        inset 0 sheet.$sheet-border-thin 0 themes.get-universal-color(white, 10),
        inset sheet.$sheet-border-accent 0 0 themes.get-semantic-color(green, 20) !important;
    }
  }

  // Unequipped gear content styling
  &--unequipped {
    .eventide-actor-data-table {
      border-left: sheet.$sheet-border-accent solid themes.get-semantic-color(gray, 40) !important;
      opacity: sheet.$sheet-opacity-unequipped !important;
      box-shadow:
        0 sheet.$sheet-border-accent sheet.$sheet-shadow-blur-lg themes.get-universal-color(black, 30),
        inset 0 sheet.$sheet-border-thin 0 themes.get-universal-color(white, 10),
        inset sheet.$sheet-border-accent 0 0 themes.get-semantic-color(gray, 15) !important;
    }
  }
}

// ===================================
// ANIMATIONS
// ===================================

@keyframes erps-tab-glow {
  0%, 100% {
    opacity: 0.2;
  }

  50% {
    opacity: 0.4;
  }
}

@keyframes erps-tab-fade-in {
  from {
    opacity: 0;
    transform: translateY(sheet.$sheet-transform-fade);
  }

  to {
    opacity: 1;
    transform: translateY(sheet.$sheet-position-zero);
  }
}
