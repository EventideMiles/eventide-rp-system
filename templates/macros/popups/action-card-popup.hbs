{{!-- Action Card Popup --}}
<div class="{{cssClass}} erps-form" autocomplete="off">
  {{> callout-box}}
  <div class="erps-form__content">
    {{> popup-header}}

    {{!-- Action Card Mode Display --}}
    <div class="erps-form__section erps-form__section--compact">
      <div class="erps-form__header erps-form__header--small erps-form__header--no-margin">
        {{localize "EVENTIDE_RP_SYSTEM.Item.ActionCard.Mode"}}
      </div>
      <div class="erps-form__mode-display">
        {{#if (eq mode "attackChain")}}
          <span class="erps-form__mode-badge erps-form__mode-badge--attack-chain">
            <i class="fas fa-bolt"></i>
            {{localize "EVENTIDE_RP_SYSTEM.Item.ActionCard.AttackChainMode"}}
          </span>
        {{else if (eq mode "savedDamage")}}
          <span class="erps-form__mode-badge erps-form__mode-badge--saved-damage">
            <i class="fas fa-heart-broken"></i>
            {{localize "EVENTIDE_RP_SYSTEM.Item.ActionCard.SavedDamageMode"}}
          </span>
        {{/if}}
      </div>
    </div>

    {{!-- Action Card Description --}}
    {{#if actionCard.system.description}}
      <div class="erps-form__section">
        <div class="erps-form__header erps-form__header--small">{{actionCard.actor.name}}</div>
        <div class="erps-form__description">
          {{{actionCard.system.description}}}
        </div>
      </div>
    {{/if}}

    {{!-- Embedded Item Section --}}
    {{#unless (eq mode "savedDamage")}}
      <div class="erps-form__section">
        <div class="erps-form__header erps-form__header--small erps-form__header--no-margin">
          {{localize "EVENTIDE_RP_SYSTEM.Item.ActionCard.EmbeddedItem"}}
        </div>

        <div class="erps-form__group erps-form__group--grid erps-form__group--grid-2">
          {{!-- Item Header with Image and Name --}}
          <div class="erps-form__group erps-form__group--compact">
            <div class="erps-form__embedded-item-header">
              <img src="{{embeddedItem.img}}" class="erps-form__image" />
              <div class="erps-form__embedded-item-info">
                <h4>{{embeddedItem.name}}</h4>
                <span class="erps-form__embedded-item-type">{{embeddedItem.type}}</span>
              </div>
            </div>
          </div>

          {{!-- Item Stats --}}
          <div class="erps-form__group erps-form__group--compact">
            <div class="erps-form__group erps-form__group--grid erps-form__group--grid-2 erps-form__group--compact">
              {{#if embeddedItem.cost}}
                <div class="erps-form__group erps-form__group--compact">
                  <label class="erps-form__label">{{localize "EVENTIDE_RP_SYSTEM.Item.Inventory.Cost.label"}}</label>
                  <div class="erps-form__description erps-form__description--data">{{embeddedItem.cost}}</div>
                </div>
              {{/if}}
              {{#if embeddedItem.usageInfo}}
                <div class="erps-form__group erps-form__group--compact">
                  <label class="erps-form__label">{{localize "EVENTIDE_RP_SYSTEM.Item.Descriptors.UsageInfo.label"}}</label>
                  <div class="erps-form__description erps-form__description--data">{{embeddedItem.usageInfo}}</div>
                </div>
              {{/if}}
              {{#if embeddedItem.formula}}
                <div class="erps-form__group erps-form__group--compact">
                  <label class="erps-form__label">{{localize "EVENTIDE_RP_SYSTEM.Forms.Sections.Formula"}}</label>
                  <div class="erps-form__description erps-form__description--data">{{embeddedItem.formula}}</div>
                </div>
              {{/if}}
            </div>
          </div>
        </div>

        {{#if embeddedItem.description}}
          <div class="erps-form__description erps-form__description--compact">
            {{{embeddedItem.description}}}
          </div>
        {{/if}}
      </div>
    {{/unless}}

    {{!-- Mode-specific Configuration Display --}}
    {{#if (eq mode "attackChain")}}
      <div class="erps-form__section erps-form__section--compact">
        <div class="erps-form__header erps-form__header--small erps-form__header--no-margin">
          {{localize "EVENTIDE_RP_SYSTEM.Item.ActionCard.ChainConfiguration"}}
        </div>

        <div class="erps-form__group erps-form__group--grid erps-form__group--grid-2 erps-form__group--compact">
          <div class="erps-form__group erps-form__group--compact">
            <label class="erps-form__label">{{localize "EVENTIDE_RP_SYSTEM.Item.ActionCard.FirstStat"}}</label>
            <div class="erps-form__description erps-form__description--data">{{attackChain.firstStat}}</div>
          </div>
          <div class="erps-form__group erps-form__group--compact">
            <label class="erps-form__label">{{localize "EVENTIDE_RP_SYSTEM.Item.ActionCard.SecondStat"}}</label>
            <div class="erps-form__description erps-form__description--data">{{attackChain.secondStat}}</div>
          </div>
        </div>

        {{#if (ne attackChain.damageCondition "never")}}
          <div class="erps-form__group erps-form__group--compact">
            <label class="erps-form__label">{{localize "EVENTIDE_RP_SYSTEM.Item.ActionCard.DamageConfig"}}</label>
            <div class="erps-form__description erps-form__description--data">
              <i class="fas fa-sword"></i>
              {{localize "EVENTIDE_RP_SYSTEM.Item.ActionCard.DamageOn"}} {{attackChain.damageCondition}}
              {{#if (eq attackChain.damageCondition "rollValue")}}
                <span class="erps-form__threshold">{{attackChain.damageThreshold}}</span>
              {{/if}}
              {{#if attackChain.damageFormula}}
                <span class="erps-form__formula">{{attackChain.damageFormula}}</span>
              {{/if}}
            </div>
          </div>
        {{/if}}

        {{#if (ne attackChain.statusCondition "never")}}
          <div class="erps-form__group erps-form__group--compact">
            <label class="erps-form__label">{{localize "EVENTIDE_RP_SYSTEM.Item.ActionCard.StatusConfig"}}</label>
            <div class="erps-form__description erps-form__description--data">
              <i class="fas fa-magic"></i>
              {{localize "EVENTIDE_RP_SYSTEM.Item.ActionCard.StatusOn"}} {{attackChain.statusCondition}}
              {{#if (eq attackChain.statusCondition "rollValue")}}
                <span class="erps-form__threshold">{{attackChain.statusThreshold}}</span>
              {{/if}}
            </div>
          </div>
        {{/if}}
      </div>
    {{else if (eq mode "savedDamage")}}
      <div class="erps-form__section erps-form__section--compact">
        <div class="erps-form__header erps-form__header--small erps-form__header--no-margin">
          {{localize "EVENTIDE_RP_SYSTEM.Item.ActionCard.SavedDamageConfiguration"}}
        </div>

        <div class="erps-form__group erps-form__group--grid erps-form__group--grid-2 erps-form__group--compact">
          <div class="erps-form__group erps-form__group--compact">
            <label class="erps-form__label">{{localize "EVENTIDE_RP_SYSTEM.Forms.Sections.Formula"}}</label>
            <div class="erps-form__description erps-form__description--data">{{savedDamage.formula}}</div>
          </div>
          <div class="erps-form__group erps-form__group--compact">
            <label class="erps-form__label">{{localize "EVENTIDE_RP_SYSTEM.Item.ActionCard.DamageType"}}</label>
            <div class="erps-form__description erps-form__description--data">{{savedDamage.type}}</div>
          </div>
        </div>
      </div>
    {{/if}}

    {{!-- Status Effect Selection --}}
    {{#if embeddedStatusEffects.length}}
      <div class="erps-form__section erps-form__section--compact">
        <div class="erps-form__header erps-form__header--small erps-form__header--no-margin">
          {{localize "EVENTIDE_RP_SYSTEM.Item.ActionCard.StatusEffectSelection"}}
        </div>

        <div class="erps-form__group erps-form__group--compact">
          <div class="erps-form__button-group" style="display: flex; gap: 8px; margin-bottom: 8px;">
            <button
              type="button"
              class="erps-button erps-button--secondary erps-button--small"
              data-action="selectAllEffects"
            >
              <i class="fas fa-check-square"></i> {{localize "EVENTIDE_RP_SYSTEM.Item.ActionCard.SelectAllEffects"}}
            </button>
            <button
              type="button"
              class="erps-button erps-button--secondary erps-button--small"
              data-action="deselectAllEffects"
            >
              <i class="fas fa-square"></i> {{localize "EVENTIDE_RP_SYSTEM.Item.ActionCard.DeselectAllEffects"}}
            </button>
          </div>

          <div class="erps-form__status-effects-list">
            {{#each embeddedStatusEffects}}
              <label class="erps-form__status-effect-item" style="display: flex; align-items: center; padding: 6px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 4px; cursor: pointer;">
                <input
                  type="checkbox"
                  class="erps-form__status-effect-checkbox"
                  name="statusEffect-{{id}}"
                  value="{{id}}"
                  checked
                  style="margin-right: 8px;"
                />
                <img src="{{img}}" alt="{{name}}" class="erps-form__effect-icon" style="width: 32px; height: 32px; object-fit: cover; border-radius: 4px; margin-right: 8px;" />
                <div class="erps-form__effect-details" style="flex: 1;">
                  <div class="erps-form__effect-name" style="font-weight: 500;">{{name}}</div>
                  {{#if description}}
                    <div class="erps-form__effect-description" style="font-size: 0.9em; color: #666;">{{description}}</div>
                  {{/if}}
                </div>
                <span class="erps-form__effect-type" style="font-size: 0.85em; color: #888; text-transform: capitalize;">{{type}}</span>
              </label>
            {{/each}}
          </div>
        </div>
      </div>
    {{/if}}

    {{!-- Transformation Selection --}}
    {{#if (and embeddedTransformations.length (ne transformationConfig.condition "never"))}}
      <div class="erps-form__section erps-form__section--compact">
        <div class="erps-form__header erps-form__header--small erps-form__header--no-margin">
          {{localize "EVENTIDE_RP_SYSTEM.Item.ActionCard.TransformationSelection"}}
        </div>

        {{#if targets.length}}
          {{#each targets}}
            <div class="erps-form__transformation-target-group">
              <div class="erps-form__transformation-target-header">
                <img src="{{this.img}}" class="erps-form__target-image" style="width: 50px; height: 50px; object-fit: cover;" />
                <span class="erps-form__target-name">{{this.name}}</span>
              </div>

              <div class="erps-form__transformation-options">
                <table class="erps-form__transformation-table" style="width: 100%; border-collapse: collapse;">
                  {{#each ../embeddedTransformations}}
                    <tr class="erps-form__transformation-row">
                      <td style="padding: 8px; border: 2px solid transparent; cursor: pointer; border-radius: 4px;"
                          data-transformation-option="{{../this.id}}"
                          data-transformation-value="{{this.id}}"
                          title="{{this.description}}">
                        <input
                          type="radio"
                          id="transformation-{{../this.id}}-{{this.id}}"
                          name="transformation-{{../this.id}}"
                          value="{{this.id}}"
                          class="erps-form__transformation-radio"
                          {{#if @first}}checked{{/if}}
                          style="display: none;"
                        />
                        <div style="display: flex; align-items: center; gap: 12px;">
                          <img src="{{this.img}}"
                               class="erps-form__transformation-icon"
                               style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;" />
                          <span class="erps-form__transformation-name" style="font-weight: 500;">{{this.name}}</span>
                        </div>
                      </td>
                    </tr>
                  {{/each}}
                  <tr class="erps-form__transformation-row">
                    <td style="padding: 8px; border: 2px solid transparent; cursor: pointer; border-radius: 4px;"
                        data-transformation-option="{{this.id}}"
                        data-transformation-value="none"
                        title="Skip transformation for this target">
                      <input
                        type="radio"
                        id="transformation-{{this.id}}-none"
                        name="transformation-{{this.id}}"
                        value="none"
                        class="erps-form__transformation-radio"
                        style="display: none;"
                      />
                      <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="erps-form__transformation-icon"
                             style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 24px; background-color: #f0f0f0; border-radius: 4px; color: #666;">
                          <i class="fas fa-ban"></i>
                        </div>
                        <span class="erps-form__transformation-name" style="font-weight: 500;">{{localize "EVENTIDE_RP_SYSTEM.Item.ActionCard.NoTransformation"}}</span>
                      </div>
                    </td>
                  </tr>
                </table>
              </div>
            </div>
          {{/each}}
        {{else}}
          <div class="erps-form__description erps-form__description--compact">
            {{localize "EVENTIDE_RP_SYSTEM.Item.ActionCard.NoTargetsForTransformation"}}
          </div>
        {{/if}}
      </div>
    {{/if}}

    {{!-- Roll Section --}}
    {{> popup-roll}}
  </div>

  {{!-- Footer with buttons --}}
  {{> macro-footer}}
</div>
