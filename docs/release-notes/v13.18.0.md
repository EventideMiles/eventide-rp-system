# v13.18.0 - GM Action Cards

**Release Date**: January 2026

## New Features

### ðŸŽ­ GM Action Cards System

**Game Masters can now create and manage action cards that are completely hidden from players.**

GM Action Cards provide a powerful new tool for Game Masters to automate secret NPC abilities, environmental effects, hidden traps, and other mechanics that should remain invisible to players. This feature maintains the mystery and surprise essential to engaging gameplay while still providing GMs with the full automation benefits of the action card system.

#### Core Functionality

- **Dedicated GM Actions Tab**: New tab on character sheets visible only to GMs (Assistant GM permission or higher)
- **Complete Player Isolation**: GM action cards never appear in player views, even on their own characters
- **Transformation Protection**: GM action cards are automatically filtered out of transformations to prevent accidental player visibility
- **Execution Permissions**: Only GMs can execute GM-only action cards, with automatic permission checks
- **Visual Indicators**: Eye-slash icon (fa-eye-slash) clearly marks the GM Actions tab

#### Smart Context-Aware Creation

The system intelligently detects which tab is active when creating or dropping action cards:

- **Drop on GM Actions Tab**: Automatically sets the `gmOnly` flag to `true`
- **Drop on Regular Tab**: Automatically sets the `gmOnly` flag to `false`
- **Create Button Integration**: "New Item" button in GM Actions tab creates GM-only cards by default
- **Drag Between Tabs**: Moving action cards between tabs automatically updates their GM-only status
- **Manual Toggle**: GM Only checkbox in action card configuration allows manual override

#### Use Cases

**Secret NPC Abilities**
- Hidden special attacks that shouldn't be telegraphed to players
- Transformation abilities that trigger under specific conditions
- Backup tactics that activate when NPCs reach certain health thresholds

**Environmental Effects**
- Automated hazards in dungeons and dangerous locations
- Weather effects that trigger periodically
- Traps that activate when specific conditions are met

**Plot Mechanics**
- Story-driven effects that need to remain secret
- Surprise reinforcements or enemy abilities
- Hidden countdown timers for dramatic reveals

**Testing & Development**
- Test action cards without exposing them to players
- Experimental mechanics that aren't ready for player use
- Quick debugging of action card configurations

#### Technical Implementation

**Data Model Changes**
- Added `gmOnly` boolean field to action card schema ([item-action-card.mjs:281-284](../module/data/item-action-card.mjs))
- Default value: `false` (maintains backward compatibility)
- Required field with proper validation

**UI Components**
- New GM Actions tab template ([gm-action-cards.hbs](../templates/actor/gm-action-cards.hbs))
- GM Only toggle in action card attributes ([action-card.hbs:65-84](../templates/item/attribute-parts/action-card.hbs))
- Conditional sheet width expansion for GMs (880px â†’ 1020px)
- Tab positioning next to regular Action Cards for easy access

**Permission System**
- Permission checks in action card execution methods
- GM-only filtering in transformation system ([actor-transformation.mjs](../module/documents/mixins/actor-transformation.mjs))
- Context preparation splits cards into regular and GM arrays ([actor-sheet-context-preparation.mjs](../module/ui/mixins/actor-sheet-context-preparation.mjs))
- Grouping support for GM action cards with full drag-drop functionality

**Smart Drag-Drop Logic**
- Active tab detection using dual approach (tabGroups + DOM check)
- Automatic `gmOnly` flag setting based on drop target tab
- Plain object conversion to handle DataModel instances correctly
- Tab-switching updates for existing action cards ([actor-sheet-drag-drop.mjs:405-417](../module/ui/mixins/actor-sheet-drag-drop.mjs))

#### Localization

**New Translation Keys** (added to `lang/src/en/actor.json` and `item.json`):

```json
// Actor sheet
"EVENTIDE_RP_SYSTEM.Actor.Tabs.GmActions": "GM Actions"
"EVENTIDE_RP_SYSTEM.Actor.ActionCards.NoGmCards": "No GM action cards configured"

// Item configuration
"EVENTIDE_RP_SYSTEM.Item.ActionCard.GmOnly.label": "GM Only"
"EVENTIDE_RP_SYSTEM.Item.ActionCard.GmOnly.hint": "This action card is only visible and executable by GMs"
```

#### Backward Compatibility

- Existing action cards automatically default to `gmOnly: false`
- No migration required - new field is optional with safe default
- Existing functionality completely unaffected
- All action card groups and transformations continue working normally

### ðŸŽ¨ Enhanced Actor Sheet Layout for GMs

**Character sheets automatically expand when GMs are viewing them to accommodate the GM Actions tab.**

- **Dynamic Width**: Sheet width increases from 880px to 1020px when GM Actions tab is present
- **Automatic Detection**: Width adjustment happens automatically based on user permissions
- **Player Experience Unchanged**: Non-GM users see the standard 880px width
- **Optimal Layout**: Additional space prevents tab crowding and improves readability

## Improvements

### Permission Enforcement

- **Runtime Validation**: GM-only action cards validate permissions at execution time
- **Clear Error Messages**: Players attempting to execute GM cards receive clear permission denial
- **Security**: Multiple layers of protection prevent unauthorized access
- **Graceful Degradation**: Non-GM users never see or interact with GM cards

### User Experience

- **Intuitive Interface**: Eye-slash icon immediately communicates restricted visibility
- **Seamless Workflow**: Drag-drop between tabs works naturally and updates flags automatically
- **Visual Feedback**: GM indicator banner clearly marks the restricted tab
- **Consistent Behavior**: Works identically to regular action cards in all other respects

### Code Quality

- **Clean Architecture**: Minimal changes to existing code, new functionality properly isolated
- **Proper Separation**: GM logic cleanly separated from player-facing systems
- **Type Safety**: Full TypeScript-style JSDoc documentation for new fields and methods
- **Performance**: Zero impact on rendering or execution speed

## Version Information

- **Release Version**: 13.18.0
- **Foundry Compatibility**: v13+ minimum, v13+ verified
- **Previous Version**: v13.17.5 introduced Enhanced Context Menus & Code Quality improvements
- **Focus**: GM-only action cards with complete player isolation

## Getting Started

### For Game Masters

1. **Access the GM Actions Tab**: Open any character sheet and look for the "GM Actions" tab (visible only to GMs)
2. **Create GM Action Cards**:
   - Click "New Item" in the GM Actions tab to create a GM-only card
   - Or drop any existing action card onto the GM Actions tab to convert it
3. **Configure Secret Abilities**: Set up attack chains, saved damage, transformations, and effects like any other action card
4. **Execute Freely**: Use GM action cards knowing players cannot see or access them
5. **Move Between Tabs**: Drag cards between GM Actions and regular Actions to toggle visibility

### For Players

- **No Changes**: The player experience is completely unchanged
- **Hidden from View**: GM action cards never appear in any player interface
- **Cannot Execute**: Even if somehow accessed, permission checks prevent execution

### Best Practices

**Organization**
- Use GM action cards for truly secret mechanics only
- Regular action cards remain the better choice for player-visible abilities
- Leverage action card groups to organize GM cards by category (traps, abilities, effects)

**Security**
- Review permissions before the session to ensure proper GM-only status
- Test execution to verify players cannot access GM cards
- Use descriptive names since players will never see them anyway

**Performance**
- GM action cards have the same performance as regular cards
- No additional overhead or rendering cost
- Feel free to use as many as needed for your game

## Technical Notes

### Architecture Decisions

**Why Boolean Flag Instead of New Item Type**
- Simpler maintenance and fewer breaking changes
- Follows existing system patterns (e.g., `cursed`, `equipped` flags)
- Easier for users to toggle without recreating items
- No need for inheritance or type conversion logic

**Why Dual Tab Detection**
- `tabGroups.primary` provides the official ApplicationV2 state
- DOM check (`querySelector`) acts as a backup for edge cases
- Ensures reliability across different rendering states
- Prevents flag setting failures during async operations

**Why Plain Object Conversion**
- DataModel instances don't serialize custom properties correctly
- `toObject()` ensures data is in the format `createEmbeddedDocuments` expects
- Prevents Foundry from overwriting flags with schema defaults
- Maintains compatibility with Foundry's data handling patterns

### Schema Changes

```javascript
// module/data/item-action-card.mjs
schema.gmOnly = new fields.BooleanField({
  required: true,
  initial: false,
});
```

### Modified Files

**Data Models**
- `module/data/item-action-card.mjs` - Added gmOnly field to schema

**UI Sheets**
- `module/ui/sheets/actor-sheet.mjs` - Added GM Actions tab, width logic, part configuration
- `module/ui/mixins/actor-sheet-context-preparation.mjs` - Split action cards into regular/GM arrays
- `module/ui/mixins/actor-sheet-document-actions.mjs` - Set gmOnly flag on create button
- `module/ui/mixins/actor-sheet-drag-drop.mjs` - Tab detection and automatic flag setting

**Templates**
- `templates/actor/gm-action-cards.hbs` - New GM Actions tab template
- `templates/item/attribute-parts/action-card.hbs` - Added GM Only toggle

**Document Mixins**
- `module/documents/mixins/actor-transformation.mjs` - Filter GM cards from transformations
- `module/documents/mixins/item-action-card-execution.mjs` - Permission checks for execution

**Localization**
- `lang/src/en/actor.json` - GM Actions tab and UI strings
- `lang/src/en/item.json` - GM Only toggle label and hint

## Known Issues

None at this time.

## Documentation

- [Action Cards Guide](../advanced-usage/action-cards.md) - Complete action cards documentation
- [Quick Start Guide](../getting-started/quick-start.md) - Get started with the system
- [Features System](../system-features/features.md) - Circumstantial bonuses and feature rolls

## Migration Notes

**From v13.17.5 to v13.18.0**
- No migration required
- Existing action cards continue working with `gmOnly: false` by default
- GM Actions tab appears automatically for GM users
- No data conversion or manual updates needed

---

**Current Version**: v13.18.0 | **Foundry VTT Compatibility**: v13+ | **Release Date**: January 2026
