# v13.21.5 - Code Refactoring & Bug Fixes

**Release Date**: February 2026

## Overview

This patch release focuses on significant code refactoring to reduce technical debt, improve code maintainability, and fix several bugs discovered after the v13.21.0 release. The main theme is de-monolitization‚Äîbreaking down large files into smaller, more manageable modules while adding essential bug fixes and quality-of-life improvements.

## Bug Fixes and Improvements

### Critical Fixes

#### Gear Depletion Timing (v13.21.5)

- **Issue**: Gear was depleting too early during action card execution, resulting in undesired n-1 behavior
- **Fix**: Corrected the timing of gear depletion to ensure it happens at the appropriate point in execution
- **Impact**: Action cards that consume gear now work correctly without consuming an extra resource

#### Character Effects Processing (v13.21.5)

- **Refactor**: Moved character effects processing to a common service that works for both embedded and regular items
- **Benefit**: Consistent behavior across all item types with reduced code duplication

#### Action Card Target Handling (v13.21.5)

- **Issue**: Status effects and transformations weren't being passed correctly via GM-control system from player action card execution
- **Fix**: Ensured selected status effects and transformations are properly passed through the GM-control system
- **Additional**: Added handling for users who un-target mid-execution in repetition action cards

### üîß Technical Improvements

#### Code De-Monolitization

Significant effort was made to reduce the size of large, monolithic files:

- **Action Card Execution**: Moved ~500 lines of business logic from [`action-card-execution.mjs`](../../module/services/action-card-execution.mjs)
- **Item Action Card Execution**: Extracted business logic from [`item-action-card-execution.mjs`](../../module/services/item-action-card-execution.mjs)
- **Item Sheet Actions**: Started reducing the size of [`item-sheet-actions.mjs`](../../module/services/item-sheet-actions.mjs)
- **Item Sheet Services**: Moved several services out of [`item-sheet.mjs`](../../module/ui/sheets/item-sheet.mjs) to avoid file bloat
- **Form Changes**: Extracted form changes functionality to a shared mixin

#### Shared Code Consolidation

- **Drag and Drop**: Moved shared code from actor and item sheet drag-and-drop handlers to a common [`drag-drop-handler.mjs`](../../module/services/drag-drop-handler.mjs) service
- **Theme Colors and Context Menus**: Moved to shared mixins to reduce code duplication across sheets
- **Helper Methods**: Broke out several helper methods from various components to improve maintainability

#### Build and Development

- **Markdownlint Configuration**: Added `.markdownlintignore` file to exempt non-public-facing files from linting
- **Glob Patterns**: Fixed glob patterns to better handle ignoring for markdownlint

### UI and UX Improvements

#### Action Card Features

- **Hint Sizing**: Fixed issue with re-render on typical installations by adjusting hint sizing

#### Settings and Configuration

- **Testing Setting**: Moved to bottom of visible settings for better organization

#### Drag and Drop Fixes

- **Updated Handler**: Fixed several bugs in the drag-and-drop handler

### üåê Localization

#### Translation Updates

- **Item Selector Combo Box**: Corrected translation strings
- **New Strings**: Added new strings to language files for translations

### Testing

#### Unit Testing

- **Character Effects Processor**: Added unit testing for the new character-effects processor service

### Security Hardening

#### XSS Prevention in Item Selector

- **Issue**: Item selector combo box was using `innerHTML` to display item data, potentially allowing XSS attacks
- **Fix**: Changed to use `textContent` instead of `innerHTML` for item names, types, and sources
- **Impact**: Prevents cross-site scripting attacks through malicious item names
- **File**: [`item-selector-combo-box.mjs`](../../module/ui/components/item-selector-combo-box.mjs)

#### Text Input Sanitization

- **Issue**: User-generated text in descriptions and biographies was not consistently sanitized
- **Fix**: All user-generated text now passes through Foundry's `enrichHTML` system
- **Impact**: Consistent HTML sanitization across all text fields prevents XSS vulnerabilities
- **Files**: [`context-preparation-helper.mjs`](../../module/services/context-preparation-helper.mjs), [`system-messages.mjs`](../../module/helpers/system-messages.mjs), [`eventide-popup-helpers.mjs`](../../module/helpers/eventide-popup-helpers.mjs), [`actor-sheet.mjs`](../../module/ui/sheets/actor-sheet.mjs), [`embedded-item-sheet.mjs`](../../module/ui/sheets/embedded-item-sheet.mjs)

#### Build Security

- **Issue**: Test and example files were being included in production releases
- **Fix**: Updated [`exclude.txt`](../../exclude.txt) to exclude test and example files from releases
- **Additional**: Console logging restricted to development mode only via ESLint rules and Logger class
- **Impact**: Reduces attack surface and prevents information leakage in production builds

#### Cursed Transformation Check

- Added cursed transformation check for actor-to-actor transformation flow
- Ensures proper handling of cursed status during transformations

### Documentation

- **Chat Message Builder**: Updated to include roll dice handling

## Version History Summary

### v13.21.5 (Current)

- Fixed gear depletion timing in action card execution
- Refactored monolithic files into smaller, manageable modules
- Added character effects common service for embedded and regular items
- Fixed status effects and transformations via GM-control system
- Improved drag-and-drop handling with common service
- Fixed hint sizing re-render issue
- Added unit testing for character effects processor
- Added cursed transformation check for actor-to-actor flow
- Updated chat message builder with roll dice handling
- **Security**: XSS prevention in item selector using textContent
- **Security**: Text input sanitization via Foundry's enrichHTML
- **Security**: Build security improvements (exclude test files, restrict console logging)

### v13.21.0

- Introduced Stat Points Formula with color-coded feedback
- Added Self-Target toggle for action cards
- Added Enforce Status Choice validation

## Getting Started

### For All Users

1. **Update Recommendation**: This release includes important bug fixes for gear depletion and code refactoring improvements. All users are recommended to update.

2. **Testing**: After updating, test action cards that consume gear to ensure they now work correctly.

### For Players

- Check your gear-consuming actions to verify they work correctly

### For Game Masters

- GM-control system properly passes status effects and transformations from player action cards
- Review your action cards that may benefit from the GM-control system improvements

## Version Information

- **Release Version**: 13.21.5
- **Foundry Compatibility**: v13+ minimum, v13+ verified
- **Focus**: Code refactoring, bug fixes, and stability improvements
- **Previous Version**: v13.21.0 introduced Action Card Enhancements & Quality of Life

## Documentation

- [Action Cards Guide](../advanced-usage/action-cards.md) - Complete action cards documentation
- [Status Effects Guide](../system-features/status-effects.md) - Status effect system reference
- [Transformations Guide](../for-gms/transformations.md) - Transformation system documentation
